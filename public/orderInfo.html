<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
	<meta charset="utf-8">
    <script src="scripts/parse-1.6.14.min.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <script src="scripts/hbMap.js"></script>

    <link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyDT_nh0aKxv4aZ263b5RGYCDRD-vjCozj0&&libraries=geometry,drawing,places"></script>
    <script src="scripts/jquery-2.2.0.min.js"></script>
     <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> -->
    <script src="scripts/bootstrap.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

    <script src="scripts/bootstrap-switch.min.js"></script>
    <link href="css/bootstrap-switch.min.css" rel="stylesheet">

    <title>小蜜蜂小幫手</title>
</head>
<body>
    <br>

    <div class="col-xl-12 col-xs-12 col-sm-12 col-md-6 col-lg-8 col-xs-offset-0 col-sm-offset-0 col-md-offset-3 col-lg-offset-2 toppad">
        <table class="table table-bordered">
            <thead>
                <tr style="background-color: #FFDD55;" >
                    <td colspan="4" align="center"><b>訂單資訊</b></td>
                </tr>

                <tr>
                    <td colspan="1">訂單編號</td>
                    <td colspan="1" id="shoppingCardId"> </td>
                    <td colspan="1">訂單狀態</td>
                    <td colspan="1" id="cartStatus"><div id="cartStatusText"> </div></td>
                 </tr>

                <tr>
                    <td colspan="1">訂單時間</td>
                    <td colspan="1" id="ETA"> </td>
                    <td colspan="1">取餐 / 送達時間</td>
                    <td colspan="1" id="ETD"> </td>
                </tr>

                <tr>
                    <td colspan="1">訂餐人</td>
                    <td colspan="1" id="ownerName"> </td>
                    <td colspan="1">電話</td>
                    <td colspan="1" id="ownerPhone"> </td>
                </tr>

                <tr>
                    <td colspan="1">小蜜蜂</td>
                    <td colspan="1" id="beeName">
                        <!--<button type="button" class="btn btn-warning btn-xs" id="appointBtn" style='margin-left:10px'>
                            <span class="glyphicon glyphicon-pencil"></span> 修改
                        </button>-->
                    </td>

                    <td colspan="1">電話</td>
                    <td colspan="1" id="beePhone"> </td>
                </tr>

                <tr>
                    <td colspan="1">餐點金額</td>
                    <td colspan="1" id="totalMealPrice"> </td>
                    <td colspan="1">運費 (訂單/小蜜蜂)</td>
                    <td colspan="1" id="shippingFee">""</td>
                </tr>

                <tr>
                    <td colspan="1">刷卡金額</td>
                    <td colspan="1" id="paySum"> </td>
                    <td colspan="1">折扣</td>
                    <td colspan="1" id="discount"> </td>
                </tr>

                <tr>
                    <td colspan="1">其他</td>
                    <td colspan="3">

                        <button type="button" class="btn btn-default" id="beeTrackerBtn">
                            <span class="glyphicon glyphicon-map-marker"></span> 小蜜蜂在哪兒?
                        </button>

                        <!-- Single button -->
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                <span class="glyphicon glyphicon-pencil"> </span>修改 <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#" id="modifyOrderInfoBtn">訂單資訊</a></li>
                                <li><a href="#" id="modifyStoreInfoBtn">取餐資訊</a></li>
                                <li><a href="#" id="modifyCustomerInfoBtn">送餐資訊</a></li>
                            </ul>
                        </div>

                    </td>
                </tr>

            </thead>

            <tbody></tbody>
        </table>
    </div>


    <div class="col-xl-12 col-xs-12 col-sm-12 col-md-6 col-lg-8 col-xs-offset-0 col-sm-offset-0 col-md-offset-3 col-lg-offset-2 toppad">
        <table class="table table-bordered" id="storeInCartTableGroup">

            <thead>
                <tr class="info">
                    <td colspan="4" align="center"><b>取餐資訊</b></td>
                </tr>
            </thead>

        </table>
    </div>


    <div class="col-xl-12 col-xs-12 col-sm-12 col-md-6 col-lg-8 col-xs-offset-0 col-sm-offset-0 col-md-offset-3 col-lg-offset-2 toppad">
        <table class="table table-bordered" id="customerInCartTableGroup">

            <thead>
                <tr class="danger">
                    <td colspan="4" align="center"><b>送餐資訊</b></td>
                </tr>
            </thead>

        </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="statusModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">注意</h4>
                </div>
                <div class="modal-body">
                    <p>是否將 訂單狀態 設成 "完成" ?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="statusBtn">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="foodTakenModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">注意</h4>
                </div>
                <div class="modal-body">
                    <p>是否將 取餐狀態 設成 "完成" ?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="foodTakenBtn">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="deliveredModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">注意</h4>
                </div>
                <div class="modal-body">
                    <p>是否將 送達狀態 設成 "完成" ?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="deliveredBtn">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="beeModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">指派小蜜蜂</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <span class="label label-primary">1</span><br />
                        <label>目前小蜜蜂:</label><font style='margin-left:10px' id="currentBeeName">無</font><br /><br />

                        <span class="label label-primary">2</span><br />
                        <p>輸入小蜜蜂電話 或</p>
                        <p>輸入"none"- 訂單放到搶標區</p>
                        <input type="text" class="form-control" placeholder="請輸入小蜜蜂電話" id="beePhoneInput">
                        <button type="submit" class="btn btn-default" id="beeSearchBtn">查詢</button><br><br>

                        <span class="label label-primary">3</span><br />
                        <label>轉移:</label><font style='margin-left:10px;margin-right:10px;' id="beeName1"></font>-><font style='margin-left:10px; color:orange' id="beeName2"></font>  <br /><br />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="appointAcceptBtn">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- createNewShoppingItemModal -->
    <div class="modal fade" id="createNewShoppingItemModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">新增餐點項目</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <span class="label label-primary">1</span><br />
                        <label for="sel1">餐點:</label>

                        <select class="form-control" id="mealItemSelect"></select>

                        <!--<label>目前小蜜蜂:</label><font style='margin-left:10px' id="currentBeeName">無</font><br /><br />-->

                        <span class="label label-primary">2</span><br />
                        <label>輸入口味描述:</label>
                        <p>ex.大杯,冷,去冰,1/2糖,加 椰果</p>
                        <p>ex.大份,小辣</p>
                        <input type="text" class="form-control" placeholder="口味描述" id="flavorInput">

                        <span class="label label-primary">3</span><br />
                        <label>單價:</label>
                        <input type="text" class="form-control" placeholder="元" id="mealUnitPriceInput">

                        <span class="label label-primary">4</span><br />
                        <label>數量:</label>
                        <input type="text" class="form-control" placeholder="份" id="mealCountInput">

                        <span class="label label-primary">5</span><br />
                        <!--<label>產生餐點項目:</label>-->
                        <button type="submit" class="btn btn-default" id="previewItemBtn">預覽</button><br><br>
                        <label>結果:</label>

                        <table class="table table-bordered">
                            <tbody id="">
                                <tr>
                                    <td colspan="1">品項</td>
                                    <td colspan="1">單價</td>
                                    <td colspan="1">數量</td>
                                    <td colspan="1">金額</td>
                                </tr>

                                <tr id="previewItemRow"></tr>

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="createShoppingItemBtn">送出</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createEditShoppingItemModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">取消餐點項目</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <span class="label label-primary">1</span><br />
                        <label for="sel1">餐點:</label>

                        <select class="form-control" id="mealEditItemSelect"></select>

                        <span class="label label-primary">2</span><br />
                        <label>數量:</label>
                        <input type="text" class="form-control" placeholder="份" id="mealEditCountInput">

                        <span class="label label-primary">3</span><br />

                        <button type="submit" class="btn btn-default" id="previewEditItemBtn">預覽</button><br><br>
                        <label>結果:</label>

                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <td colspan="1">品項</td>
                                    <td colspan="1">單價</td>
                                    <td colspan="1">數量</td>
                                    <td colspan="1">金額</td>
                                </tr>

                                <tr id="previewEditItemRow"></tr>

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="createEditShoppingItemBtn">送出</button>
                </div>
            </div>
        </div>
    </div>

    <!--追蹤小蜜蜂位置UI畫面-->
    <div class="modal fade" id="beeTrackerModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>

                    <h4 class="modal-title">地圖 </h4>

                    <form class="form-inline">
                        <div class="col-lg-3">
                            <select class="form-control" id="locationProviderSelect">
                                <option value="all" selected>all</option>
                                <option value="gps">gps</option>
                                <option value="network">network</option>
                            </select>
                            <button type="button" class="btn btn-success" style='margin-left:10px;' id="locationRefreshBtn"><span class="glyphicon glyphicon-refresh"></span> 刷新</button>
                        </div>
                       
                    </form>

                </div>

                <div class="modal-body">
                    <div id="googleMap" style="width:100%;height:450px"></div>
                </div>
            </div>
        </div>
    </div>

    <!--修改訂單資訊UI畫面-->
    <div class="modal fade" id="modifyOrderInfoModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">編輯訂單資訊</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <!--<span class="label label-primary">1</span><br />-->

                        <label for="sel1">訂單狀態:</label>

                        <form class="form-inline">
                            <div class="form-group">
                                <select class="form-control" id="cartStatusSelect">
                                    <option value="onbid" selected>競標中</option>
                                    <option value="ongoing">取餐中</option>
                                    <option value="shipping">送餐中</option>
                                    <option value="complete">完成</option>
                                    <option value="cancel">取消</option>
                                </select>
                            </div>
                        </form>
                        
                        <br>

                        <label for="sel1">小蜜蜂:</label>
                        <form class="form-inline">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="小蜜蜂名字" id="modifyBee" disabled>
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" id="modifyBeeBtn">修改</button>
                                    </span>
                                </div>
                            </div>
                        </form>

                        <br>
                        <label for="sel1">給小蜜蜂運費:</label>
                        <form class="form-inline">
                            <div class="form-group">
                                <!--<font for="sel1">訂餐者</font>-->
                                <!--<input type="number" class="form-control" placeholder="顧客支付" id="modifyShippingFee" disabled><br>-->
                                <!--<font for="sel1">小蜜蜂</font>-->
                                <input type="number" class="form-control" placeholder="付給小蜜蜂" id="modifyPayBee">
                            </div>
                        </form>

                        <br>
                        <label for="sel1">折扣:</label>
                        <form class="form-inline">
                            <div class="form-group">
                                <input type="number" class="form-control" placeholder="折扣" id="modifyDiscount">
                            </div>
                        </form>


                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="saveCartInfoBtn">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!--修改店家資訊UI畫面-->
    <div class="modal fade" id="modifyStoreInfoModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">編輯取餐資訊</h4>
                   
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <!--<span class="label label-primary">1</span><br />-->

                        <label for="sel1">選擇店家:</label>
                        
                        <form class="form-inline">

                    		<div class="form-group">
                             	<select class="form-control" id="storeInCartItemSelect"></select>
                    		 	<button type="button" class="btn btn-default" id="addNewStoreBtn"><span class='glyphicon glyphicon-plus'></span>新增</button>
                    		</div>

                    	</form>
                        
                       
                        <br>
                        <label for="sel1">取餐時間:</label>

                        <form class="form-inline">

                            <div class="form-group">
                                <input type="date" class="form-control" value="2013-01-08" id="storeDeliverDate">
                                <input type="time" class="form-control" value="18:56" id="storeDeliverTime">
                            </div>

                        </form>

                        <br>
                        <label>店家訂單通知:</label><br>

                        <input type="checkbox" name="my-checkbox" data-on-text="收到" data-off-text="未收到" data-on-color="success" id="storeInCartRepliedCheck"><br>
               
                        <br>
                        <label>小蜜蜂取餐:</label><br>

                        <input type="checkbox" name="my-checkbox" data-on-text="取餐" data-off-text="未取餐" data-on-color="success" id="storeInCartFoodTakenCheck"><br>
                   

                        <br>
                        <label>小蜜蜂準時:</label><br>
                        
                        <label class="form-check-inline">
                            <input class="form-check-input" type="radio" name="beeArrivalRadioOptions" id="beeArrivalRadio1" value="early"> 提早
                        </label>    
                        <label class="form-check-inline">
                            <input class="form-check-input" type="radio" name="beeArrivalRadioOptions" id="beeArrivalRadio2" value="ontime"> 準時
                        </label>    
                        <label class="form-check-inline" >
                            <input class="form-check-input" type="radio" name="beeArrivalRadioOptions" id="beeArrivalRadio3" value="late"> 遲到
                        </label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="saveStoreInfo">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!--修改運送資訊UI畫面-->
    <div class="modal fade" id="modifyCustomerInfoModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">編輯送餐資訊</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <label for="sel1">選擇地點:</label>
                     
                        
                        <form class="form-inline">

                            <div class="form-group">
                                <select class="form-control" id="customerInCartItemSelect"></select>
                                <button type="button" class="btn btn-default" id="addNewCustmerBtn"><span class='glyphicon glyphicon-plus'></span>新增</button>
                            </div>

                        </form>

                        <br>
                        <label for="sel1">送達時間:</label>

                        <form class="form-inline">
                            <div class="form-group">
                                <input type="date" class="form-control" value="2013-01-08" id="customerArrivalDate">
                                <input type="time" class="form-control" value="18:56" id="customerArrivalTime">
                            </div>
                        </form>

                        <br>
                        <label>代收現金:</label>
                        <input type="number" class="form-control" placeholder="金額" id="customerCash">

                        <br>
                        <label for="sel1">聯絡人:</label>
                        <form class="form-inline">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="聯絡人" id="customerName">
                                <input type="text" class="form-control" placeholder="電話" id="customerPhone">
                            </div>
                        </form>

                        <br>
                        <label>送餐地址:</label>
                        <input type="text" class="form-control" placeholder="送餐地址" id="customerAddress">

                        <br>
                        <label>地址備註:</label>
                        <input type="text" class="form-control" placeholder="地址備註" id="customerAddressNote">

                        <br>
                        <label>完成送餐:</label><br>

                        <input type="checkbox" name="my-checkbox" data-on-text="送達" data-off-text="未送達" data-on-color="success" id="customerInCartArrivalCheck"><br>

                        <br>
                        <label>小蜜蜂準時:</label><br>

                        <label class="form-check-inline">
                            <input class="form-check-input" type="radio" name="beeArrivalCustomerRadioOptions" id="beeArrivalCustomerRadio1" value="early"> 提早
                        </label>
                        <label class="form-check-inline">
                            <input class="form-check-input" type="radio" name="beeArrivalCustomerRadioOptions" id="beeArrivalCustomerRadio2" value="ontime"> 準時
                        </label>
                        <label class="form-check-inline">
                            <input class="form-check-input" type="radio" name="beeArrivalCustomerRadioOptions" id="beeArrivalCustomerRadio3" value="late"> 遲到
                        </label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="saveCustomerInfo">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!--找外送人員-->
    <div class="modal fade" id="searchBeeModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">查詢小蜜蜂</h4>
                </div>
                <div class="modal-body">

                    <label for="sel1">輸入電話或名字:</label>
                    <form class="form-inline">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="電話" id="searchBeePhoneInput">
                            <input type="text" class="form-control" placeholder="名字" id="searchBeeNameInput" list="beeNameList">
                             <datalist id="beeNameList"></datalist>
                        </div>

                        <button type="button" class="btn btn-success" id="searchBeeBtn"><span class="glyphicon glyphicon-search"></span> 查詢</button>
                    </form>

                    <br>

                    <table class="table table-bordered">

                        <thead>
                            <tr>
                                <td colspan="1">選擇</td>
                                <td colspan="1">小蜜蜂</td>
                                <td colspan="1">電話</td>
                                
                            </tr>
                        </thead>
                        <tbody id="beeTableBody"></tbody>
                    </table>

                </div><br>


                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="beeAcceptBtn">確定</button>
                </div>


            </div>
        </div>
    </div>
    
    <!--新增店家-->
    <div class="modal fade" id="selectStoreModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">選擇新增店家</h4>
                </div>
                <div class="modal-body">

                    <label for="sel1">選擇店家:</label>

                    <select class="form-control" id="selectNewStoreItem"></select>

                    <br>

                </div><br>


                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="selectStoreAcceptBtn">確定</button>
                </div>


            </div>
        </div>
    </div>
    
    <!--新增外送地點-->
    <div class="modal fade" id="addNewCustomerModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">新增外送地點</h4>
                </div>
                <div class="modal-body">

                     <label for="sel1">送達時間:</label>

                        <form class="form-inline">
                            <div class="form-group">
                                <input type="date" class="form-control" value="2013-01-08" id="newCustomerArrivalDate">
                                <input type="time" class="form-control" value="18:56" id="newCustomerArrivalTime">
                            </div>
                        </form>

                        <br>
                        <label>代收現金:</label>
                        <input type="number" class="form-control" placeholder="金額" id="newCustomerCash">

                        <br>
                        <label for="sel1">聯絡人:</label>
                        <form class="form-inline">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="聯絡人" id="newCustomerName">
                                <input type="text" class="form-control" placeholder="電話" id="newCustomerPhone">
                            </div>
                        </form>

                        <br>
                        <label>送餐地址:</label>
                        <input type="text" class="form-control" placeholder="送餐地址" id="newCustomerAddress">

                        <br>
                        <label>地址備註:</label>
                        <input type="text" class="form-control" placeholder="地址備註" id="newCustomerAddressNote">


                </div><br>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" id="addNewCustomerAcceptBtn">確定</button>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        $("[name='my-checkbox']").bootstrapSwitch();

        $(function () {
        	
            var createStoreItemTable = function (storeInCarts) {

                for (var i = 1, len = storeInCarts.length; i <= len; i++) {
                    $("#storeInCartTableGroup").append(
                         $("<tbody id='storeItemTable" + i + "'></tbody>").append(
                              $("<tr>").append(
                                    $("<td colspan='4' class='active'></td>").append(
                                        $("<span class = 'pull-left' ><b id='storeName" + i + "'</b></span>")
                                    )
                               ),
                               $("<tr>").append(
                                    $("<td colspan='1'>地址</td>"),
                                    $("<td colspan='1' id='storeAddress" + i + "'></td>"),
                                    $("<td colspan='1'>電話</td>"),
                                    $("<td colspan='1' id='storePhone" + i + "'></td>")
                               ),
                               $("<tr>").append(
                                    $("<td colspan='1'>取餐時間</td>"),
                                    $("<td colspan='1' id='etd" + i + "'></td>"),
                                    $("<td colspan='2'></td>")
                               ),
                               $("<tr>").append(
                                    $("<td colspan='1'>取餐碼</td>"),
                                    $("<td colspan='1' id='foodTakenCode" + i + "'></td>"),
                                    $("<td colspan='1'>準時抵達</td>"),
                                    $("<td colspan='1' id='arriveStatus" + i + "'></td>")
                               ),
                               $("<tr>").append(
                                    $("<td colspan='1'>已收到訂單</td>"),
                                    $("<td colspan='1' id='storeReplied" + i + "'></td>"),
                                    $("<td colspan='1'>已完成取餐</td>"),
                                    $("<td colspan='1' id='storeFoodTaken" + i + "'><font id='cartStatusText'></td>")
                               ),
                               $("<tr>").append(
                                    $("<td colspan='4'></td>").append(
                                        $("<table class='table table-user-information'></table>").append(
                                            $("<thead>").append(
                                                $("<tr class='active'></tr>").append(
                                                    $("<th width=20>#</th>"),
                                                    $("<th>品項</th>"),
                                                    $("<th width=80>數量</th>"),
                                                    $("<th width=80>單價</th>"),
                                                    $("<th width=80>金額</th>")
                                                )
                                            ),
                                            $("<tbody id='storeItem" + i + "'></tbody>"),
                                            $("<tfoot>").append(
                                                $("<tr>").append(
                                                    $("<td colspan='2'></td>").append(
                                                        $("<button type='button' class='btn btn-info btn-xs' id='storeAddItemBtn" + i + "'><span class='glyphicon glyphicon-plus'></span> 新增</button>"),
                                                        $("<button type='button' class='btn btn-danger btn-xs' id='storeEditItemBtn" + i + "' style='margin-left: 6px'><span class='glyphicon glyphicon-trash'></span> 刪除</button>")
                                                    ),
                                                    $("<td colspan='3'></td>")
                                                ),
                                                $("<tr>").append(
                                                    $("<td colspan='3'></td>"),
                                                    $("<td colspan='1'><b>總價</b></td>"),
                                                    $("<td colspan='1'><b id='sum" + i + "'></b></td>")
                                                    )
                                                )
                                            )
                                    )
                               )
                        )

                    );

                }

            };

            var createCustomerItemTable = function (customerInCarts) {

                for (var i = 1, len = customerInCarts.length; i <= len; i++) {
                    $("#customerInCartTableGroup").append(
                                                       $("<tbody id='customerItemTable" + i + "'></tbody>").append(
                                                           $("<tr>").append(
                                                               $("<td colspan='4' class='active'>地點 " + i + "</td>")
                                                           ),
                                                            $("<tr>").append(
                                                               $("<td colspan='1'>聯絡人</td>"),
                                                               $("<td colspan='1' id='customerName" + i + "'></td>"),
                                                               $("<td colspan='1'>電話</td>"),
                                                               $("<td colspan='1' id='customerPhone" + i + "'></td>")
                                                           ),
                                                           $("<tr>").append(
                                                               $("<td colspan='1'>送達時間</td>"),
                                                               $("<td colspan='1' id='eta" + i + "'></td>"),
                                                               $("<td colspan='1'>代收現金</td>"),
                                                               $("<td colspan='1' id='cash" + i + "'></td>")
                                                           ),
                                                           $("<tr>").append(
                                                               $("<td colspan='1'>地址</td>"),
                                                               $("<td colspan='1' id='sendTo" + i + "'></td>"),
                                                               $("<td colspan='1'>準時抵達</td>"),
                                                               $("<td colspan='1' id='arriveCustomerStatus" + i + "'></td>")
                                                           ),
                                                           $("<tr>").append(
                                                               $("<td colspan='1'>備註</td>"),
                                                               $("<td colspan='3' id='note" + i + "'></td>")
                                                           ),
                                                            $("<tr>").append(
                                                               $("<td colspan='1'>已完成送餐</td>"),
                                                               $("<td colspan='3' id='delivered" + i + "'></td>")
                                                           )
                                                       )
                                                   );
                }
            };

            var showCartInfo = function (cart) {
                $("#shoppingCardId").html(cart.id);
                
                $("#cartStatusText").html(covertShoppingCartStatus(cart));

                $("#ETA").html(format(cart.get("submittedDate"), 'yyyy-MM-dd hh:mm'));
                $("#ETD").html(format(cart.get("ETD"), 'yyyy-MM-dd <b>hh:mm</b>') + " / " + format(cart.get("ETA"), '<b>hh:mm</b>'));

                $("#ownerName").html(cart.get('owner') != null ? cart.get('owner').get("contact") : "");
                $("#ownerPhone").html(cart.get('owner') != null ? cart.get('owner').get("phone") : "");

                $("#beeName").html(cart.get('bee') != null ? $('<a href=beeInfo.html?objectId=' + cart.get('bee').id + ' target=_blank>').html(cart.get('bee').get("contact")) : "");

                $("#beePhone").html(cart.get('bee') != null ? cart.get('bee').get("phone") : "");
                $("#shippingFee").html(cart.get('shippingFee') + " / " + cart.get('payToBee'));
                $("#discount").html(cart.get('discount'));
                $("#paySum").html(cart.get('totalPrice'));
                $("#totalMealPrice").html(cart.get('totalPrice') - cart.get('discount') - cart.get('shippingFee'));
            };

            var showStoreInfo = function (cart , storeInCarts) {
                storeInCarts.forEach(function (storeInCart, index, array) {

                    //顯示Store Head 資訊
                    showStoreHeadInfo(cart, storeInCart, index);

                    //顯示餐點清單
                    showFoodItemList(cart, storeInCart, index);
                    
                });

            };

            var showCustomerInfo = function (customerInCarts) {

                customerInCarts.forEach(function (customerInCart, index, array) {
                    var contact = customerInCart.get('contact') != null ? customerInCart.get('contact') : "";
                    var phone = customerInCart.get('phone') != null ? customerInCart.get('phone') : "";
                    var address = customerInCart.get('address') != null ? customerInCart.get('address') : "";
                    var addressNote = customerInCart.get('addressNote') != null ? customerInCart.get('addressNote') : "";

                    $("#customerName" + (index + 1)).html(contact);
                    $("#customerPhone" + (index + 1)).html(phone);
                    $("#sendTo" + (index + 1)).html(address);
                    $("#note" + (index + 1)).html(addressNote);
                    $("#eta" + (index + 1)).html(format(customerInCart.get("ETA"), 'yyyy-MM-dd <b>hh:mm</b>'));

                    $("#arriveCustomerStatus" + (index + 1)).html(covertBeeArrivalStatus(customerInCart.get("beeArrival"))); //*covertBeeArrivalStatus function in hbUtility.js

                    var deliveredIcon;
                    if (customerInCart.get('delivered')) {
                        deliveredIcon = $("<i class='fa fa-check' style='margin-left:10px ; color:#00DD00;' ></i>");
                    } else {
                        deliveredIcon = $("<i class='fa fa-times' style='margin-left:10px ; color:#DD0000;'></i>");

                        deliveredIcon.click(function () {
                            console.log("deliveredIcon click" + customerInCart.id);
                            $('#deliveredModal').modal('show');

                            $('#deliveredBtn').prop('onclick', null).off('click');
                            $('#deliveredBtn').click(function () {

                                console.log("deliveredBtn click: " + customerInCart.id);

                                customerInCart.set("delivered", true);
                                customerInCart.save();
                                alert("已完成修改");
                                location.reload();
                            });
                        });
                    }
                    //var foodTakenIcon = customerInCart.get('delivered') ? $("<i class='fa fa-check' style='margin-left:10px ; color:#00DD00;' ></i>") : $("<i class='fa fa-times' style='margin-left:10px ; color:#DD0000;'></i>");
                    $("#delivered" + (index + 1)).append(deliveredIcon);

                    var cash = customerInCart.get('cash') != null ? customerInCart.get('cash') : "無";
                    $("#cash" + (index + 1)).html(cash);

                    //$("<i class='fa fa-check-square' style=' margin-left:10px ; color:#00DD00;></i>")
                    $("#customerItemTable" + (index + 1)).show();

                });

            };
  
            var showStoreHeadInfo = function (cart,storeInCart, index) {
          
                $("#storeName" + (index + 1)).html(storeInCart.get('store').get('storeName'));
                $("#storePhone" + (index + 1)).html(storeInCart.get('store').get('phone'));
                $("#storeAddress" + (index + 1)).html(storeInCart.get('store').get('address'));
                $("#foodTakenCode" + (index + 1)).html(getCheckCode(storeInCart.id));    // *getCheckCode function in hbUtility.js
                $("#arriveStatus" + (index + 1)).html(covertBeeArrivalStatus(storeInCart.get("beeArrival"))); //*covertBeeArrivalStatus function in hbUtility.js
                $("#etd" + (index + 1)).html(storeInCart.get('ETD') != null ? format(storeInCart.get("ETD"), 'yyyy-MM-dd <b>hh:mm</b>') : format(cart.get("ETD"), 'yyyy-MM-dd <b>hh:mm</b>'));
                if (storeInCart.get('replied')) {
                    $("#storeReplied" + (index + 1)).append($("<i class='fa fa-check' style=' margin-left:10px ; color:#00DD00;' ></i>"));
                } else {
                    $("#storeReplied" + (index + 1)).append($("<i class='fa fa-times' style=' margin-left:10px ; color:#DD0000;' ></i>"));
                }

                var foodTakenIcon;
                if (storeInCart.get('foodTaken')) {
                    foodTakenIcon = $("<i class='fa fa-check' style=' margin-left:10px ; color:#00DD00;' ></i>");
                } else {
                    foodTakenIcon = $("<i class='fa fa-times' style=' margin-left:10px ; color:#DD0000;' ></i>");
                    foodTakenIcon.click(function () {
                        $('#foodTakenModal').modal('show');

                        $('#foodTakenBtn').prop('onclick', null).off('click');
                        $('#foodTakenBtn').click(function () {

                            console.log("foodTakenBtn click: " + storeInCart.id);

                            storeInCart.set("foodTaken", true);
                            storeInCart.save();

                            alert("已完成修改");
                            location.reload();
                        });
                    });
                }

                $("#storeFoodTaken" + (index + 1)).append(foodTakenIcon);

            };

            var showFoodItemList = function (cart,storeInCart, index) {

                var itemGroup = [];
                var keyArray = [];

                var HBShoppingItem = Parse.Object.extend("HBShoppingItem");
                var itemQuery = new Parse.Query(HBShoppingItem);
                itemQuery.include('meal');
                itemQuery.equalTo('store', storeInCart.get('store'));
                itemQuery.equalTo('shoppingCart', cart);
                itemQuery.descending("meal");
                itemQuery.find({
                    success: function (items) {
                        var sum = 0;
                        items.forEach(function (item, itemIndex, array) {
                            var mealId = item.get('meal').id;
                            var itemKey = item.get('itemKey');
                            var key = mealId + itemKey;

                            if (itemGroup[key] == null) {
                                itemGroup[key] = new Array();
                                keyArray.push(key);
                            }

                            itemGroup[key].push(item);
                        });

                        keyArray.sort();
                        keyArray.forEach(function (key, keyIndex, array) {

                            var itemsForKey = itemGroup[key];

                            var mealName;
                            var itemNameForDisplay;
                            var unitPrice;
                            var itemQty = 0;

                            for (var i = 0, len = itemsForKey.length ; i < len; i++) {

                                if (i == 0) {
                                    mealName = itemsForKey[i].get('meal').get("mealName");
                                    itemNameForDisplay = itemNameForDisplayFormat(itemsForKey[i].get("itemNameForDisplay")); //*itemNameForDisplayFormat function in  HBUtility.js
                                    unitPrice = itemsForKey[i].get("unitPrice");
                                }

                                itemQty += itemsForKey[i].get("qty");
                            }

                            var totalPrice = itemQty * unitPrice;
                            sum += totalPrice;

                            $('#storeItem' + (index + 1)).append($('<tr>').append(
                                $('<td>').html((keyIndex + 1)),
                                $('<td>').html(mealName + itemNameForDisplay),
                                $('<td>').html(itemQty),
                                $('<td>').html(unitPrice),
                                $('<td>').html(totalPrice)
                            ));

                        });

                        $('#sum' + (index + 1)).html(sum);
                        
                    	// 新增餐點內容按鈕
                  		addFoodItemButtonInit(cart, storeInCart, index);

                		// 刪除餐點內容按鈕
                  		removeFoodItemButtonInit(cart, storeInCart, index, keyArray, itemGroup);

                    }, error: function (e) {

                    }
                });
            };

            var addFoodItemButtonInit = function (cart,storeInCart,index) {

                $("#storeAddItemBtn" + (index + 1)).click(function () {
                    $('#createNewShoppingItemModal').modal('show');

                    var HBMealSet = Parse.Object.extend("HBMealSet");
                    var mealQuery = new Parse.Query(HBMealSet);

                    mealQuery.equalTo('belongTo', storeInCart.get('store'));
                    mealQuery.limit(1000);
                    mealQuery.find({
                        success: function (meals) {

                            $("#mealItemSelect").html("");
                            $("#flavorInput").val("");
                            $("#mealUnitPriceInput").val("");
                            $("#mealCountInput").val("");

                            meals.forEach(function (meal, mealIndex, array) {
                                var optionName = meal.get('mealName') + " - " + meal.get('price') + "元";
                                $("#mealItemSelect").append($("<option></option>").attr("value", mealIndex).text(optionName));
                            });

                            $('#previewItemBtn').prop('onclick', null).off('click');
                            $("#previewItemBtn").click(function () {

                                var index = $("#mealItemSelect option:selected").val();
                                var selectMeal = meals[index];
                                var flavorInput = $("#flavorInput").val();
                                var mealUnitPriceInput = parseInt($("#mealUnitPriceInput").val());
                                var mealCountInput = parseInt($("#mealCountInput").val());

                                if (isNaN(mealCountInput) || isNaN(mealUnitPriceInput)) {
                                    alert("數量和單價輸入必須為數字");
                                }

                                $("#previewItemRow").html("");
                                $("#previewItemRow").append(
                                    $('<td>').html(selectMeal.get('mealName') + itemNameForDisplayFormat(flavorInput)), //*itemNameForDisplayFormat function in  HBUtility.js
                                    $('<td>').html(mealUnitPriceInput),
                                    $('<td>').html(mealCountInput),
                                    $('<td>').html(mealUnitPriceInput * mealCountInput));
                            });

                            $('#createShoppingItemBtn').prop('onclick', null).off('click');
                            $("#createShoppingItemBtn").click(function () {
                                //console.log("select value =  " + $("#mealItemSelect option:selected").text());
                                var index = $("#mealItemSelect option:selected").val();
                                var selectMeal = meals[index];
                                var flavorInput = $("#flavorInput").val();
                                var mealUnitPriceInput = parseInt($("#mealUnitPriceInput").val());
                                var mealCountInput = parseInt($("#mealCountInput").val());

                                if (isNaN(mealCountInput) || isNaN(mealUnitPriceInput)) {
                                    alert("數量和單價輸入必須為數字");
                                    return;
                                }

                                var ShoppingItem = Parse.Object.extend("HBShoppingItem");
                                var newShoppingitem = new ShoppingItem();

                                newShoppingitem.set("addFrom", "hungrybee");
                                newShoppingitem.set("bags", 0);
                                newShoppingitem.set("itemKey", selectMeal.id + flavorInput + "-add");
                                newShoppingitem.set("itemNameForDisplay", flavorInput + "(新增)");
                                newShoppingitem.set("meal", selectMeal);
                                newShoppingitem.set("store", storeInCart.get('store'));
                                newShoppingitem.set("owner", Parse.User.current());
                                newShoppingitem.set("qty", mealCountInput);
                                newShoppingitem.set("shoppingCart", cart);
                                newShoppingitem.set("subTotal", mealUnitPriceInput * mealCountInput);
                                newShoppingitem.set("unitPrice", mealUnitPriceInput);

                                newShoppingitem.save(null, {
                                    success: function (newShoppingitem) {
                                        // Execute any logic that should take place after the object is saved.
                                        alert('已完成新增');
                                        location.reload();
                                    },
                                    error: function (newShoppingitem, error) {
                                        // Execute any logic that should take place if the save fails.
                                        // error is a Parse.Error with an error code and message.
                                        alert('Failed to create new object, with error code: ' + error.message);
                                    }
                                });
                            });

                        }, error: function (e) {

                        }
                    });
                });
            };

            var removeFoodItemButtonInit = function (cart, storeInCart, index,keyArray,itemGroup) {

                $("#storeEditItemBtn" + (index + 1)).click(function () {

                    $('#createEditShoppingItemModal').modal('show');

                    $("#mealEditItemSelect").html("");
                    $("#mealEditCountInput").html("");

                    var qtyArray = new Array();

                    keyArray.forEach(function (key, keyIndex, array) {

                        var itemsForKey = itemGroup[key];
                        var mealName;
                        var itemNameForDisplay;
                        var unitPrice;
                        var itemQty = 0;

                        for (var i = 0, len = itemsForKey.length ; i < len; i++) {

                            if (i == 0) {
                                mealName = itemsForKey[i].get('meal').get("mealName");
                                itemNameForDisplay = itemsForKey[i].get("itemNameForDisplay");
                                unitPrice = itemsForKey[i].get("unitPrice");
                            }

                            itemQty += itemsForKey[i].get("qty");
                        }

                        qtyArray.push(itemQty);

                        var optionName = mealName + itemNameForDisplayFormat2(itemNameForDisplay) + " - " + unitPrice + "元" + " x " + itemQty + "份"; //*itemNameForDisplayFormat2 function in  HBUtility.js
                        $("#mealEditItemSelect").append($("<option></option>").attr("value", keyIndex).text(optionName));

                    });

                    $('#previewEditItemBtn').prop('onclick', null).off('click');
                    $("#previewEditItemBtn").click(function () {

                        var index = $("#mealEditItemSelect option:selected").val();
                        var key = keyArray[index];

                        var itemsForKey = itemGroup[key];
                        var mealName = itemsForKey[0].get('meal').get("mealName");
                        var itemNameForDisplay = itemsForKey[0].get("itemNameForDisplay");
                        var unitPrice = itemsForKey[0].get('unitPrice');
                        var qty = qtyArray[index];

                        var mealCountInput = parseInt($("#mealEditCountInput").val());
                        console.log("mealCountInput =  " + mealCountInput);

                        if (isNaN(mealCountInput)/* || isNaN(mealUnitPriceInput)*/) {
                            alert("數量輸入必須為數字");
                            return;
                        }

                        if (mealCountInput > qty) {
                            alert("輸入的數量超過訂單數量");
                            return;
                        }

                        $("#previewEditItemRow").html("");
                        $("#previewEditItemRow").append(
                            $('<td>').html(mealName + " - " + itemNameForDisplayFormat2(itemNameForDisplay) + "(取消)"), //*itemNameForDisplayFormat2 function in  HBUtility.js
                            $('<td>').html(unitPrice),
                            $('<td>').html(mealCountInput),
                            $('<td>').html(unitPrice * mealCountInput));
                    });

                    $('#createEditShoppingItemBtn').prop('onclick', null).off('click');
                    $("#createEditShoppingItemBtn").click(function () {

                        var index = $("#mealEditItemSelect option:selected").val();
                        var key = keyArray[index];

                        var itemsForKey = itemGroup[key];
                        var mealName = itemsForKey[0].get('meal').get("mealName");
                        var itemNameForDisplay = itemsForKey[0].get("itemNameForDisplay")!=null?itemsForKey[0].get("itemNameForDisplay"):"";
                        var unitPrice = itemsForKey[0].get('unitPrice');
                        var qty = qtyArray[index];
                        var itemKey = itemsForKey[0].get("itemKey") + "-cancel";

                        var mealCountInput = parseInt($("#mealEditCountInput").val());
                        console.log("mealCountInput =  " + mealCountInput);

                        if (isNaN(mealCountInput)/* || isNaN(mealUnitPriceInput)*/) {
                            alert("數量輸入必須為數字");
                            return;
                        }

                        if (mealCountInput > qty) {
                            alert("輸入的數量超過訂單數量");
                            return;
                        }


                        var ShoppingItem = Parse.Object.extend("HBShoppingItem");
                        var newShoppingitem = new ShoppingItem();

                        newShoppingitem.set("addFrom", "hungrybee");
                        newShoppingitem.set("bags", 0);
                        newShoppingitem.set("itemKey", itemKey);
                        newShoppingitem.set("itemNameForDisplay", itemNameForDisplay + "(取消)");
                        newShoppingitem.set("meal", itemsForKey[0].get('meal'));
                        newShoppingitem.set("store", storeInCart.get('store'));
                        newShoppingitem.set("owner", Parse.User.current());
                        newShoppingitem.set("qty", 0 - mealCountInput);
                        newShoppingitem.set("shoppingCart", cart);
                        newShoppingitem.set("subTotal", unitPrice * (0 - mealCountInput));
                        newShoppingitem.set("unitPrice", unitPrice);

                        newShoppingitem.save(null, {
                            success: function (newShoppingitem) {
                                alert('已完成修改');
                                location.reload();
                            },
                            error: function (newShoppingitem, error) {
                                alert('Failed to create new object, with error code: ' + error.message);
                            }
                        });

                    });

                });
            };

            var modifyOrderInfoButtonInit = function (cart) {

                $("#modifyOrderInfoBtn").click(function () {
                    $('#modifyOrderInfoModal').modal('show');

                    $('#modifyBee').val( cart.get('bee') != null ? cart.get('bee').get('contact') : "" );
                    $("#cartStatusSelect").children().each(function () {
                        if ($(this).val() == cart.get('status')) {
                            $(this).attr("selected", true); 
                        }
                    });

                    $("#modifyPayBee").val(cart.get('payToBee'));
                    $("#modifyDiscount").val(cart.get('discount'));

                    var currentBee = null;
                    $("#modifyBeeBtn").off('click');
                    $("#modifyBeeBtn").click(function () {
                        $('#searchBeeModal').modal('show');
                           
                    if(localStorage.beeNames != null){
                        localBeeeNameList = JSON.parse(localStorage.beeNames);
                    }else{
                        localBeeeNameList = [];
                    }
            			
            			
						localBeeeNameList.forEach(function(element){
							console.log(element);
							$("#beeNameList").append($("<option>").val(element));
						});	
			
                        
                        
                        
                        var beeList = [];

                        $('#searchBeeBtn').off('click');
                        $('#searchBeeBtn').click(function () {
                            $("#beeTableBody tr").remove();

                            var username = $('#searchBeePhoneInput').val()!== "" ? "driver-" + $('#searchBeePhoneInput').val() : null;
                            var beeName = $('#searchBeeNameInput').val() !== "" ? $('#searchBeeNameInput').val() : null;

                            if (username == null && beeName == null && username!=="" && beeName!=="") {
                                alert("請輸入電話或名字");
                                return;
                            }

                            var query = new Parse.Query(Parse.User);
                            if (username != null) {
                                query.equalTo("username", username);
                            }
                            if (beeName != null) {
                                query.startsWith("contact", beeName);
                            }
                            query.find({
                                success: function (users) {

                                    beeList = users;

                                    if (users.length == 0) {
                                        alert("查無此小蜜蜂");
                                    } else if (users.length > 1) {
                                        alert("有相同的username");
                                    }

                                    users.forEach(function (user, index, array) {
                                    	
                                        $('#beeTableBody').append(
                                            $('<tr>').append(
                                                $('<td>').html("<input class='form-check-input' type='radio' name='beeRow' value='" + index + "' checked>"),
                                                $('<td>').html($('<a href=beeInfo.html?objectId=' + user.id + ' target=_blank>').html(user.get('contact'))),
                                                $('<td>').html(user.get('phone'))
                                            )
                                         );
                                         
                                        var index = localBeeeNameList.indexOf(user.get('contact'));
                    	
                    					if(index !== -1){
                    						localBeeeNameList.splice(index, 1);
											console.log("splice" + user.get('contact'));
                    					}
                    		
                    					localBeeeNameList.unshift(user.get('contact'));
                                         
                                    });

									var max = 50;
                    				if(localBeeeNameList.length > max){
                    					localBeeeNameList.splice(max,localBeeeNameList.length - max);
                    				}
                    
                    				localStorage.beeNames = JSON.stringify(localBeeeNameList);
		
                                }, error: function (error) {

                                }
                            });



                            $("#beeAcceptBtn").off('click');
                            $("#beeAcceptBtn").click(function () {
                                //alert($('input[name=beeRow]:checked').val() + "  " + beeList[parseInt($('input[name=beeRow]:checked').val())].get('contact'));

                                currentBee = beeList[parseInt($('input[name=beeRow]:checked').val())];
                                $("#modifyBee").val(currentBee.get('contact'));
                               
                                $("#cartStatusSelect").children().each(function () {
                                    if ($(this).val() === 'ongoing') {
                                        $(this).attr("selected", true);
                                    }
                                });


                            });

                        });
                    });

                    $("#saveCartInfoBtn").off('click');
                    $("#saveCartInfoBtn").click(function () {

                        var cartStatus = $("#cartStatusSelect").val();
                        var payToBee = parseInt($("#modifyPayBee").val());
                        var discount = parseInt($("#modifyDiscount").val());

                        var oldBee = cart.get('bee');

                        //var bidCount = currentBee != null ? 99 : 0;

                        if (cartStatus === "onbid") {
                            cart.unset('bee');
                            cart.unset('bidCount');
                        } else if (currentBee != null) {
                            cart.set('bee', currentBee);
                            cart.set('bidCount', 99 );
                        }
                        
                        if(cartStatus === "complete" ){
                        	 cart.set("completeDate", new Date());
                        }
  
                        cart.set("status", cartStatus);
                        cart.set("payToBee", payToBee);
                        cart.set("discount", discount);
                        cart.save(null, {
                            success: function (updateCart) {

								//原本小蜜蜂，後來換另一個小蜜蜂
                                if (oldBee != null && currentBee != null && currentBee.id !== oldBee.id) {
                                    
                                    Parse.Cloud.run("updateBeeDeliverStatus", { userId: oldBee.id, delivering: false }, {
                                        success: function (result) {
                                            console.log("oldBee deliver update successful.");

                                            Parse.Cloud.run("updateBeeDeliverStatus", { userId: currentBee.id, delivering: true }, {
                                                success: function (result) {
                                                    console.log("newBee deliver update successful.");
                                                    alert("更新成功");
                                                    location.reload();
                                                }, error: function (e) {
                                                    console.log(e);
                                                    alert("發生錯誤 請洽工程人員修改小蜜蜂運送狀態!");
                                                }
                                                
                                            });

                                        }, error: function (e) {
                                            console.log(e);
                                            alert("發生錯誤 請洽工程人員修改小蜜蜂運送狀態!");
                                        }
                                    });
                                    
                                 // 狀態改為搶單，原本有小蜜蜂 
                                } else if (cartStatus === "onbid" && oldBee != null) {

                                    Parse.Cloud.run("updateBeeDeliverStatus", { userId: oldBee.id, delivering: false }, {
                                        success: function (result) {
                                            console.log("newBee deliver update successful.");
                                            alert("更新成功");
                                            location.reload();
                                        }, error: function (e) {
                                            console.log(e);
                                            alert("發生錯誤 請洽工程人員修改小蜜蜂運送狀態!");
                                        }
                                    });

								// 原本無小蜜蜂，後指派小蜜蜂
                                } else if (oldBee == null && currentBee != null) {
                                    console.log("oldBee == null && currentBee != null");
                                    var isDelivered = !(cartStatus === "complete");

                                    Parse.Cloud.run("updateBeeDeliverStatus", { userId: currentBee.id, delivering: isDelivered }, {
                                        success: function (result) {
                                            console.log("newBee deliver update successful.");
                                            alert("更新成功");
                                            location.reload();
                                        }, error: function (e) {
                                            console.log(e);
                                            alert("發生錯誤 請洽工程人員修改小蜜蜂運送狀態!");
                                        }
                                    });
                                
                                // 狀態改為完成，原本有小蜜蜂
                                } else if(oldBee != null && cartStatus === "complete"){
                                	
                                	console.log("oldBee != null && cartStatus === complete");
                                	Parse.Cloud.run("updateBeeDeliverStatus", { userId: oldBee.id, delivering: false }, {
                                        success: function (result) {
                                            console.log("newBee deliver update successful.");
                                            alert("更新成功");
                                            location.reload();
                                        }, error: function (e) {
                                            console.log(e);
                                            alert("發生錯誤 請洽工程人員修改小蜜蜂運送狀態!");
                                        }
                                    });

                                } else {
                                    console.log("nothing");
                                    alert("更新成功");
                                    location.reload();
                                }

                            },
                            error: function (updateCart, error) {
                             
                            }

                        });

                    });

                });
            };

            var modifyStoreInfoButtonInit = function (storeInCarts) {

                $("#modifyStoreInfoBtn").click(function () {
                    $('#modifyStoreInfoModal').modal('show');

                    var currentStoreInCartIndex = 0;
                    var repliedArray = [];
                    var foodTakenArray = [];
                    var etdArray = [];
                    var beeArrivalArray = [];

                    var showStoreInCartInfo = function (storeInCarts) {
                        $('#storeInCartRepliedCheck').off('switchChange.bootstrapSwitch');
                        $('#storeInCartFoodTakenCheck').off('switchChange.bootstrapSwitch');

                        $("#storeDeliverDate").val(format(etdArray[currentStoreInCartIndex], 'yyyy-MM-dd'));
                        $("#storeDeliverTime").val(format(etdArray[currentStoreInCartIndex], 'hh:mm'));

                        $("#storeInCartRepliedCheck").bootstrapSwitch('state', repliedArray[currentStoreInCartIndex]);
                        $("#storeInCartFoodTakenCheck").bootstrapSwitch("state", foodTakenArray[currentStoreInCartIndex]);

                        $("#storeInCartRepliedCheck").on('switchChange.bootstrapSwitch', function (event, state) {
                            repliedArray[currentStoreInCartIndex] = state;
                        });

                        $("#storeInCartFoodTakenCheck").on('switchChange.bootstrapSwitch', function (event, state) {
                            foodTakenArray[currentStoreInCartIndex] = state;
                            $("input[name=beeArrivalRadioOptions]").prop("disabled", !foodTakenArray[currentStoreInCartIndex]);
                        });

                        $("input[name=beeArrivalRadioOptions]").prop("disabled", !foodTakenArray[currentStoreInCartIndex]);

                        if (beeArrivalArray[currentStoreInCartIndex] === "early") {
                            $("#beeArrivalRadio1").prop("checked", true);
                        } else if (beeArrivalArray[currentStoreInCartIndex] === "ontime") {
                            $("#beeArrivalRadio2").prop("checked", true);
                        } else if (beeArrivalArray[currentStoreInCartIndex] === "late") {
                            $("#beeArrivalRadio3").prop("checked", true);
                        } else {
                            $("input[name=beeArrivalRadioOptions]").prop("checked", false);
                        }

                    };
                    
                    $('#addNewStoreBtn').prop('onclick', null).off('click');
                    $('#addNewStoreBtn').click(function(){
                        $('#modifyStoreInfoModal').modal('hide');
                        
                        var HBFoodStore = Parse.Object.extend("HBFoodStore");
                        var query = new Parse.Query(HBFoodStore);
                        query.equalTo('online',true);
                        query.find({
                            success:function(stores){
                                stores.forEach(function(store){
                                     $("#selectNewStoreItem").append($("<option></option>").attr("value", store.id).text(store.get('storeName')));
                                });
                                 
                            },error:function(error){
                                
                            }

                        });
                        
                        
                        $('#selectStoreModal').modal('show');
                        
                        $('#selectStoreAcceptBtn').click(function(){
                            // alert($("#selectNewStoreItem").find(":selected").text()+$("#selectNewStoreItem").find(":selected").val());
                            var cart = storeInCarts[0].get('cart');
                            var store = Parse.Object.extend("HBFoodStore").createWithoutData($("#selectNewStoreItem").find(":selected").val());
                            
                            var HBStoreInCart = Parse.Object.extend("HBStoreInCart");
                            var newStoreInCart = new HBStoreInCart();
                            newStoreInCart.set('cart',cart);
                            newStoreInCart.set('store',store);
                            newStoreInCart.save({
                               success:function(savedStoreInCart){
                                  alert("完成新增，接下來請在進入修改取餐資訊，修改其他設定");
                                  location.reload();
                                   
                               },error:function(error){
                                   alert("新增資料失敗");
                               } 
                                
                            });
                            
                        });
                        
                    });

                    $("#storeInCartItemSelect").html("");
                    storeInCarts.forEach(function (storeInCart, index, array) {
                        $("#storeInCartItemSelect").append($("<option></option>").attr("value", index).text(storeInCart.get('store').get('storeName')));
                        repliedArray[index] = storeInCart.get('replied');
                        foodTakenArray[index] = storeInCart.get('foodTaken');
                        etdArray[index] = storeInCart.get('ETD') != null ? storeInCart.get('ETD') : storeInCart.get('cart').get('ETD');
                        beeArrivalArray[index] = storeInCart.get('beeArrival');
                    });
                    
                    showStoreInCartInfo(storeInCarts[0]);

                    $("#storeInCartItemSelect").off('change');
                    $("#storeInCartItemSelect").change(function () {

                        etdArray[currentStoreInCartIndex] = new Date($("#storeDeliverDate").val() + " " + $("#storeDeliverTime").val());
                        beeArrivalArray[currentStoreInCartIndex] = $('input[name=beeArrivalRadioOptions]:checked').val();
                        currentStoreInCartIndex = $("#storeInCartItemSelect").val();
                        showStoreInCartInfo(storeInCarts[$("#storeInCartItemSelect").val()]);

                    });

                    $('#saveStoreInfo').prop('onclick', null).off('click');
                    $("#saveStoreInfo").click(function () {
                        etdArray[currentStoreInCartIndex] = new Date($("#storeDeliverDate").val() + " " + $("#storeDeliverTime").val());
                        beeArrivalArray[currentStoreInCartIndex] = $('input[name=beeArrivalRadioOptions]:checked').val();

                        repliedArray.forEach(function (isReplied, index, array) {
                            console.log("index = " + index + " : " + isReplied);
                        });

                        storeInCarts.forEach(function (storeInCart, index, array) {
                            storeInCart.set('replied', repliedArray[index]);
                            storeInCart.set('foodTaken', foodTakenArray[index]);
                            storeInCart.set('ETD', etdArray[index]);
                            storeInCart.set('beeArrival', beeArrivalArray[index]);
                        });

                        Parse.Object.saveAll(storeInCarts, {
                            success: function (list) {
                                alert("完成修改");
                                location.reload();
                            },
                            error: function (error) {
                                alert("資料儲存失敗");
                            },
                        });

                    });
                });

            };

            var modifyCustomerInfoButtonInit = function (customerInCarts) {

                $("#modifyCustomerInfoBtn").click(function () {
                    $('#modifyCustomerInfoModal').modal('show');

                    var currentCustomerInCartIndex = 0;

                    var etaArray = [];
                    var deliveredArray = [];
                    var beeArrivalArray = [];
                    var customerNameArray = [];
                    var customerPhoneArray = [];
                    var customerAddressArray = [];
                    var customerAddressNoteArray = [];
                    var customerCashArray = [];

                    var updateCurrentData = function () {
                        etaArray[currentCustomerInCartIndex] = new Date($("#customerArrivalDate").val() + " " + $("#customerArrivalTime").val());
                        customerCashArray[currentCustomerInCartIndex] = $("#customerCash").val();
                        customerNameArray[currentCustomerInCartIndex] = $("#customerName").val();
                        customerPhoneArray[currentCustomerInCartIndex] = $("#customerPhone").val();
                        customerAddressArray[currentCustomerInCartIndex] = $("#customerAddress").val();
                        customerAddressNoteArray[currentCustomerInCartIndex] = $("#customerAddressNote").val();
                        beeArrivalArray[currentCustomerInCartIndex] = $('input[name=beeArrivalCustomerRadioOptions]:checked').val();

                        currentCustomerInCartIndex = $("#customerInCartItemSelect").val();
                    };

                    var showCustomerInCartInfo = function () {

                        $('#customerInCartArrivalCheck').off('switchChange.bootstrapSwitch');
                        $("#customerArrivalDate").val(format(etaArray[currentCustomerInCartIndex], 'yyyy-MM-dd'));
                        $("#customerArrivalTime").val(format(etaArray[currentCustomerInCartIndex], 'hh:mm'));
                        $("#customerCash").val(customerCashArray[currentCustomerInCartIndex]);
                        $("#customerName").val(customerNameArray[currentCustomerInCartIndex]);
                        $("#customerPhone").val(customerPhoneArray[currentCustomerInCartIndex]);
                        $("#customerAddress").val(customerAddressArray[currentCustomerInCartIndex]);
                        $("#customerAddressNote").val(customerAddressNoteArray[currentCustomerInCartIndex]);

                        $("#customerInCartArrivalCheck").bootstrapSwitch("state", deliveredArray[currentCustomerInCartIndex]);

                        $("#customerInCartArrivalCheck").on('switchChange.bootstrapSwitch', function (event, state) {
                            deliveredArray[currentCustomerInCartIndex] = state;
                            $("input[name=beeArrivalCustomerRadioOptions]").prop("disabled", !deliveredArray[currentCustomerInCartIndex]);
                        });

                        $("input[name=beeArrivalCustomerRadioOptions]").prop("disabled", !deliveredArray[currentCustomerInCartIndex]);

                        if (beeArrivalArray[currentCustomerInCartIndex] === "early") {
                            $("#beeArrivalCustomerRadio1").prop("checked", true);
                        } else if (beeArrivalArray[currentCustomerInCartIndex] === "ontime") {
                            $("#beeArrivalCustomerRadio2").prop("checked", true);
                        } else if (beeArrivalArray[currentCustomerInCartIndex] === "late") {
                            $("#beeArrivalCustomerRadio3").prop("checked", true);
                        } else {
                            $("input[name=beeArrivalCustomerRadioOptions]").prop("checked", false);
                        }

                    };

                    $("#customerInCartItemSelect").html("");
                    customerInCarts.forEach(function (customerInCart, index, array) {

                        $("#customerInCartItemSelect").append($("<option></option>").attr("value", index).text("地點" + (index + 1) + " (" + customerInCart.get("address") + ")"));

                        etaArray[index] = customerInCart.get("ETA");
                        deliveredArray[index] = customerInCart.get("delivered");
                        beeArrivalArray[index] = customerInCart.get("beeArrival");
                        customerCashArray[index] = customerInCart.get("cash");
                        customerNameArray[index] = customerInCart.get("contact");
                        customerPhoneArray[index] = customerInCart.get("phone");
                        customerAddressArray[index] = customerInCart.get("address");
                        customerAddressNoteArray[index] = customerInCart.get("addressNote");

                    });

                    showCustomerInCartInfo();

                    $("#customerInCartItemSelect").off('change');
                    $("#customerInCartItemSelect").change(function () {
                        updateCurrentData();
                        showCustomerInCartInfo();
                    });

                    $('#saveCustomerInfo').prop('onclick', null).off('click');
                    $("#saveCustomerInfo").click(function () {
                        updateCurrentData();
						var promises = [];
                        customerInCarts.forEach(function (customerInCart, index, array) {

                            customerInCart.set('ETA', etaArray[index]);
                            customerInCart.set('cash', parseInt(customerCashArray[index]));
                            customerInCart.set('contact', customerNameArray[index]);
                            customerInCart.set('phone', customerPhoneArray[index]);
                            customerInCart.set('address', customerAddressArray[index]);
                            customerInCart.set('addressNote', customerAddressNoteArray[index]);
                            customerInCart.set('delivered', deliveredArray[index]);
                            customerInCart.set('beeArrival', beeArrivalArray[index]);
                            
                            var p = Parse.Cloud.run("findGeoPointByAddress", { address: customerAddressArray[index] },{
                            	success: function (result) {
                            		console.log(result);
                            		// alert(result.l);
                            		
                            		customerInCart.set('location',  result /*new GeoPoint({latitude: result.latitude, longitude: result.longitude})*/);
                            	
                        		}, error: function (error) {
                        			console.log(error);
                        		}
                            	
                            });
                            promises.push(p);
                        });
                        
                    	Parse.Promise.when(promises).then(function(results) {
							Parse.Object.saveAll(customerInCarts, {
                            	success: function (list) {
                               		alert("完成修改");
                                	location.reload();
                            	},
                            	error: function (error) {
                                	alert("資料儲存失敗");
                            	}
                        	});
						});

                    });
                    
                    $('#addNewCustmerBtn').prop('onclick', null).off('click');
                    $('#addNewCustmerBtn').click(function(){
                    
                        $('#modifyCustomerInfoModal').modal('hide');
                        $('#addNewCustomerModal').modal('show');
                        
                        var cart = customerInCarts[0].get('cart');
                        $("#newCustomerArrivalDate").val(format(cart.get('ETA'), 'yyyy-MM-dd'));
                        $("#newCustomerArrivalTime").val(format(cart.get('ETA'), 'hh:mm'));
                        $("#newCustomerCash").val(0);
                        $("#newCustomerName").val("");
                        $("#newCustomerPhone").val("");
                        $("#newCustomerAddress").val("");
                        $("#newCustomerAddressNote").val("");

                        $('#addNewCustomerAcceptBtn').prop('onclick', null).off('click'); 
                        $('#addNewCustomerAcceptBtn').click(function(){
                          
                            var eta = new Date($("#newCustomerArrivalDate").val() + " " + $("#newCustomerArrivalTime").val());
                            var cash = $("#newCustomerCash").val();
                            var name = $("#newCustomerName").val();
                            var phone = $("#newCustomerPhone").val();
                            var address  = $("#newCustomerAddress").val();
                            var addressNote = $("#newCustomerAddressNote").val();
                           
                            if(address == null || address === ""){
                                 alert("地址為必填資訊");
                                 return;
                            }
                            
                            Parse.Cloud.run("findGeoPointByAddress", { address: address },{
                                success: function (result) {

                                    var HBCustomerInCart = Parse.Object.extend("HBCustomerInCart");
                                    var newCustomerInCart = new HBCustomerInCart();
                                    newCustomerInCart.set('cart',cart);
                                    newCustomerInCart.set('ETA',eta);
                                    newCustomerInCart.set('cash',parseInt(cash));
                                    newCustomerInCart.set('contact',name);
                                    newCustomerInCart.set('phone',phone);
                                    newCustomerInCart.set('address',address);
                                    newCustomerInCart.set('addressNote',addressNote);
                                    newCustomerInCart.set('location',result);

                                    newCustomerInCart.save({
                                        success:function(savedCustomerInCart){
                                            alert("完成新增");
                                            location.reload();
                                   
                                        },error:function(error){
                                            console.log(error);
                                            alert("新增資料失敗");
                                        } 
                                
                                    });
                                
                                
                                }, error: function (error) {
                                    console.log(error);
                                    alert("輸入的地址無效");
                                }
                                
                            });
                            
                            

                            
                        }); 
                         
                         
                      
                        
                  
                         
                    });
                
                });


            };

            var trackingBeeInit = function (cart,object) {

                $("#beeTrackerBtn").click(function () {
                    var storeInCartArray = object.storeInCarts;
                    var customerInCartArray = object.customerInCarts;

                    if (storeInCartArray != null && customerInCartArray != null) {

                        var googleMapInit = function () {
                            var mapProp = {
                                center: new google.maps.LatLng(24.783062, 120.997068),
                                zoom: 13,
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                            };
                            var map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
                            //map.setOptions({ scrollwheel: false });
                            return map;
                        };

                        $('#beeTrackerModal').prop('on', null).off('shown.bs.modal');
                        $('#beeTrackerModal').on('shown.bs.modal', function () {

                            var map = googleMapInit();

                            storeInCartArray.forEach(function (storeInCart, index, array) {
                                addStoreMarkerInMap(storeInCart, map);
                            });

                            customerInCartArray.forEach(function (customerInCart, index, array) {
                                addSendToMarkerInMap(customerInCart, map);
                            });

                            var markers;
                            var path;

                            var provider = $("#locationProviderSelect").val();

                            getAllHBLocations(cart, provider, function (result) {
                                result = goodHBLocation(result);
                                markers = drawMarkerInMap(result, map);
                                 path = drawPathInMap(result, map);
                                runSnapToRoad(result,map);
                                
                            });

                            $('#locationRefreshBtn').prop('onclick', null).off('click');
                            $('#locationRefreshBtn').click(function () {
                            	
                                if (markers != null) {
                                    clearMarkers(markers);
                                }

                                if (path != null) {
                                    clearPath(path);
                                }
                                
                                // if(snappedPolyline != null){
//                                 	
                                	 // snappedPolyline.setMap(null);
                                // }

                                var provider = $("#locationProviderSelect").val();
                                getAllHBLocations(cart, provider, function (result) {
                                    result = goodHBLocation(result);
                                    markers = drawMarkerInMap(result, map);
                                    path = drawPathInMap(result, map);
                                    
                                    if (markers.length != 0) {
                                        map.setCenter(markers[markers.length - 1].position);
                                    }
                                    
                                    runSnapToRoad(result,map);

                                });
                            });
                        });

                        $('#beeTrackerModal').modal('show');
					}
				});

			};

			//main process
			var mainProcess = function() {
				var objectId = getUrlParameter('objectId');
				var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
				var query = new Parse.Query(HBShoppingCart);
				query.include('sendTo');
				query.include('owner');
				query.include('bee');
				query.get(objectId, {
					success : function(cart) {
						var cartInfoObject = {storeInCarts : [],customerInCarts : []};

						//顯示訂單資訊
						showCartInfo(cart);

						//取餐資訊
						var HBStoreInCart = Parse.Object.extend("HBStoreInCart");
						var storeInCartQuery = new Parse.Query(HBStoreInCart);
						storeInCartQuery.include('store');
						storeInCartQuery.equalTo('cart', cart);
						storeInCartQuery.ascending("ETD");
						storeInCartQuery.find({
							success : function(storeInCarts) {
								cartInfoObject.storeInCarts = storeInCarts;

								//動態產生取餐資訊的Table
								createStoreItemTable(storeInCarts);

								//顯示取餐資訊
								showStoreInfo(cart, storeInCarts);

								//初始化修改店家資訊按鈕
								modifyStoreInfoButtonInit(storeInCarts);

							},
							error : function(e) {

							}
						});

						//送達客戶資訊
						var HBCustomerInCart = Parse.Object.extend("HBCustomerInCart");
						var customerInCartQuery = new Parse.Query(HBCustomerInCart);
						customerInCartQuery.ascending('ETA');
						customerInCartQuery.equalTo('cart', cart);
						customerInCartQuery.find({
							success : function(customerInCarts) {
								cartInfoObject.customerInCarts = customerInCarts;

								//動態產生送達資訊的Table
								createCustomerItemTable(customerInCarts);

								//顯示送達資訊
								showCustomerInfo(customerInCarts);

								//初始化修改取餐資訊按鈕
								modifyCustomerInfoButtonInit(customerInCarts);

							},error : function(e) {

							}
						});

						//初始化追蹤小蜜蜂
						trackingBeeInit(cart, cartInfoObject);

						//初始化修改訂單資訊按鈕
						modifyOrderInfoButtonInit(cart);

					},error : function(e) {

					}
				});

			};

			mainProcess();

			// var test = function(){		
			// Parse.Cloud.run("calculateETD", {cartId:"5O7LNWucNj"}, {
                            	// success: function (result) {
                            		// console.log(result);
                            		// alert(result);
                        		// }, error: function (error) {
                        			// console.log(error);
                        		// }                             	
                            // });
			// };
			
			// test();
			
			
	});
	
    </script>
</body>
</html>