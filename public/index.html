<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />

    <!--<script src="//www.parsecdn.com/js/parse-1.6.14.min.js"></script>-->
    <script src="scripts/parse-1.6.14.min.js"></script>
    <script src="scripts/jquery-2.2.0.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <link href="https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!--<script src="http://maps.googleapis.com/maps/api/js"></script>-->
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyDG1oDvvPNi3vfwFcONINhSiyQZWFgm9Q4&&libraries=geometry"></script>
    <!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDG1oDvvPNi3vfwFcONINhSiyQZWFgm9Q4"></script>-->
    
     <script type="text/javascript">
        //test
        //Parse.initialize("UWZqpCsyFQWnyLTChFrK6t19NyLtmm7m0W2gP2ul", "GSmSLSAz7FfGyfXXB9wCvtwIJULXPHBFkM2PzwdZ");

         //Parse.initialize("9O3uQHctMnz86F6m3lifIlwKrMGONwlUjO2OL4uf", "nbkR1HRcOkFEa4J73rPsWvaZsqa6O6BHI0GSGClz");

         //var currentUser = Parse.User.current();
         //if (currentUser == null) {
         //    console.log("user = null");
         //} else {
         //    console.log("user id = " + currentUser.id);

         //    currentUser.fetch({
         //        success: function (user) {
         //            currentUser = user;
         //            console.log("user = " + user.id);
         //            var isQualify = currentUser.get("qualify");

         //            if (!isQualify) {
         //                Parse.User.logOut().then(() => {
         //                    console.log("logOut");
         //                    var currentUser = Parse.User.current();  // this will now be null
         //                    window.open("login.html", "_parent", "", true);
         //                });
         //            }

         //        }, error: function (e) {
         //            console.log("e = " + e);
         //        }
         //    });
         //}


    </script>

    <!--
        視需要在下方的中繼標籤中自訂內容安全性原則。將 'unsafe-inline' 加入 default-src 以啟用內嵌 JavaScript。
        如需詳細資料，請參閱 http://go.microsoft.com/fwlink/?LinkID=617521
    -->

    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'unsafe-inline' 'self' https: data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *">-->
    <title>小蜜蜂小幫手</title>


    <style>
        .ui-widget-header, .ui-state-default, ui-button {
            background: #faa732;
            border: 1px solid #faa732;
            color: #FFFFFF;
            Font-family: Ms Gothic;
            /*font-weight: bold;*/
        }

    </style>

</head>

<body id="main">
    <div id="dialog-1"></div>
    <div id="dialog-2"></div>

    <!--<div id="googleMap" style="width:500px;height:380px;"></div>-->
  
    <div id="loading_dialog"></div>

        <ul class="nav nav-pills">
            <li role="presentation" class="dropdown active">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                    訂單查詢 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                    <li><a href="index.html?mode=id">訂單編號</a></li>
                    <li><a href="index.html?mode=date">訂單日期</a></li>
                </ul>
                <!--<a href="index.html">訂單查詢</a>-->
            </li>

            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                    帳單查詢 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                    <li><a href="storeBill.html">店家帳單</a></li>
                    <li><a href="beeShippingFee.html">小蜜蜂帳單</a></li>
                </ul>
            </li>

            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                    銀行匯款 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                    <li><a href="bankTransfer_store.html">店家匯款</a></li>
                    <li><a href="bankTransfer_bee.html">小蜜蜂匯款</a></li>
                </ul>
            </li>

            <li role="presentation"><a href="storeManagement.html">店鋪管理</a></li>
            <li role="presentation" class="dropdown"><a href="beeManagement.html">小蜜蜂管理</a></li>
            <li role="presentation" class="dropdown"><a href="activeUserManagement.html">活動紀錄查詢</a></li>

            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                    其他 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                    <li><a href="coupon.html" target=_blank>折價卷產生器</a></li>
                    <li><a href="holdOrderTool.html" target=_blank>卡單小幫手</a></li>
                    <li><a href="" onclick="parseLogOut()">登出</a></li>
                </ul>
            </li>

        </ul>

        <header id="welcome">
            <table>
                <tr id="idSearchRow">
                    <td>
                        <input id="cartId" type="text" class="form-control" placeholder="訂單編號" aria-describedby="basic-addon1">
                    </td>
                    <td valign="top">
                        <button class="btn btn btn-warning" id="searchBtn" onclick="searchOnClick()">嗡嗡嗡...</button>
                        <a href='orderManagement.html' target=_blank>移動到新版介面</a>
                    </td>
                </tr>
                <tr id="dateSearchRow" style="display:none">
                    <td>
                        <input id="orderDate" type="date" min="2015-01-02">
                    </td>
                    <td valign="top">
                        <button class="btn btn btn-warning" id="searchBtn" onclick="dateSearchBtnOnClick()">嗡嗡嗡...</button>
                        <a href='orderManagement.html' target=_blank>移動到新版介面</a>
                    </td>
                </tr>
            </table>
            <div id="dateCartTableView" class="table-responsive">
                <table class="table" id="todayCartTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>編號</th>
                            <th>狀態</th>
                            <th>產生時間</th>
                            <th>取餐 / 送達時間</th>
                            <th>小蜜蜂</th>
                        </tr>
                    </thead>
                </table>
            </div>

            <p></p>
        </header>

        <div id="orderInfo">
            <table border="1" id="orderTable">
                <tr bgcolor="#FFDD55">
                    <td colspan="4" align="center">訂單資訊</td>
                </tr>
                <tr>
                    <td colspan="1">訂單編號</td>
                    <td colspan="1" id="shoppingCardId"></td>
                    <td colspan="1">訂單狀態</td>
                    <td colspan="1" id="cartStatus"><font id="cartStatusText"></font></td>
                </tr>

                <tr>
                    <td colspan="1">訂單時間</td>
                    <td colspan="1" id="ETA"></td>
                    <td colspan="1">取餐 / 送達時間</td>
                    <td colspan="1" id="ETD"></td>
                </tr>

                <tr>
                    <td colspan="1">訂餐人</td>
                    <td colspan="1" id="ownerName"></td>
                    <td colspan="1">電話</td>
                    <td colspan="1" id="ownerPhone"></td>
                </tr>

                <tr>
                    <td colspan="1">小蜜蜂</td>
                    <td colspan="1" id="beeName"></td>
                    <td colspan="1">電話</td>
                    <td colspan="1" id="beePhone"></td>
                </tr>

                <tr>
                    <td colspan="1">餐點金額</td>
                    <td colspan="1" id="totalMealPrice"></td>
                    <td colspan="1">運費</td>
                    <td colspan="1" id="shippingFee"></td>
                </tr>

                <tr>
                    <td colspan="1">刷卡金額</td>
                    <td colspan="1" id="paySum"></td>
                    <td colspan="1">折扣</td>
                    <td colspan="1" id="discount"></td>
                </tr>

                <tr>
                    <td colspan="1">送餐地址</td>
                    <td colspan="3" id="sendTo"></td>
                </tr>

                <tr>
                    <td colspan="1">送餐備註</td>
                    <td colspan="3" id="note"></td>
                </tr>


                <tr bgcolor="#dddddd">
                    <td colspan="4" align="center">餐點資訊</td>
                </tr>
            </table>
        </div>

        <div id="loadingIcon">
            <i class="fa fa-refresh fa-spin" style="font-size:36px; color:orange;"></i>
        </div>

        <div id="mapView">
            <div id="mapControlView">
                <button class="btn" id="showBeePathBtn">顯示路徑</button>
                <button class="btn" id="mapReflesh">更新</button>
            </div>
            <div id="googleMapInfoView">
                <div id="updateTimeView">
                    更新時間:
                    <i id="updateTime" />
                </div>
                <div id="googleMap" style="width:800px;height:480px;" />
            </div>
        </div>

        <script>

            $(function () {

                window.open("orderManagement.html", "_parent", "", true);
                return;

                $("#mapControlView").hide();
                $("#updateTimeView").hide();

                $.widget("artistan.loading", $.ui.dialog, {
                    options: {
                        // your options
                        spinnerClassSuffix: 'spinner',
                        spinnerHtml: 'waiting',// allow for spans with callback for timeout...
                        maxHeight: false,
                        maxWidth: false,
                        minHeight: 80,
                        minWidth: 220,
                        height: 80,
                        width: 220,
                        modal: true
                    },

                    _create: function () {
                        $.ui.dialog.prototype._create.apply(this);
                        // constructor
                        $(this.uiDialog).children('*').hide();
                        var self = this,
                        options = self.options;
                        self.uiDialogSpinner = $('.ui-dialog-content', self.uiDialog)
                            .html(options.spinnerHtml)
                            .addClass('ui-dialog-' + options.spinnerClassSuffix);
                    },
                    _setOption: function (key, value) {
                        var original = value;
                        $.ui.dialog.prototype._setOption.apply(this, arguments);
                        // process the setting of options
                        var self = this;

                        switch (key) {
                            case "innerHeight":
                                // remove old class and add the new one.
                                self.uiDialogSpinner.height(value);
                                break;
                            case "spinnerClassSuffix":
                                // remove old class and add the new one.
                                self.uiDialogSpinner.removeClass('ui-dialog-' + original).addClass('ui-dialog-' + value);
                                break;
                            case "spinnerHtml":
                                // convert whatever was passed in to a string, for html() to not throw up
                                self.uiDialogSpinner.html("" + (value || '&#160;'));
                                break;
                        }
                    },
                    _size: function () {
                        $.ui.dialog.prototype._size.apply(this, arguments);
                    },
                    // other methods
                    loadStart: function (newHtml) {
                        if (typeof (newHtml) != 'undefined') {
                            this._setOption('spinnerHtml', newHtml);
                        }
                        this.open();
                    },
                    loadStop: function () {
                        this._setOption('spinnerHtml', this.options.spinnerHtml);
                        this.close();
                    }
                });

                $('#dateCartTableView').hide();
                $('#orderInfo').hide();
                $('#loadingIcon').hide();

                $("#dialog-1").dialog({
                    autoOpen: false,
                    modal: true,
                    hide: {
                        effect: "blind"
                    },
                    height: 100,
                });

                $("#dialog-2").dialog({
                    autoOpen: false,
                    modal: true,
                    hide: {
                        effect: "blind"
                    },
                    buttons: {
                        取消: function () { $(this).dialog("close"); },
                        確定: function () {
                            $("#dialog-2").dialog("close");
                            $("#loading_dialog").loading();

                            setShoppingCartCompleted($("#shoppingCardId").text(), function (isSuccess, cart) {
                                $("#loading_dialog").loading("loadStop");
                                if (isSuccess) {
                                    //$("#cartStatus").html((covertShoppingCartStatus(cart.get("status"))));

                                    $("#cartStatusText").html((covertShoppingCartStatus(cart.get("status"))));

                                    $("#dialog-1").dialog({ title: "金手指大顯神威" });
                                    $("#dialog-1").html("完成囉~");
                                    $("#dialog-1").dialog("open");
                                } else {
                                    $("#dialog-1").dialog({ title: "Opps" });
                                    $("#dialog-1").html("金手指好像壞掉囉~");
                                    $("#dialog-1").dialog("open");
                                }
                            });
                        }

                    }
                }
                );
            });

            var cartTable = document.getElementById("todayCartTable");
            var updateLock = false;

            var mode = getUrlParameter('mode');
            if (mode == "id") {
                idMode();
            } else if (mode == "date") {
                dateMode();
            }

            function idMode() {
                $('#orderInfo').hide();
                $('#dateSearchRow').hide();
                $('#idSearchRow').show();
            }

            function dateMode() {
                $('#orderInfo').hide();
                $('#idSearchRow').hide();
                $('#dateSearchRow').show();
            }

            function dateSearchBtnOnClick() {
                $('#orderInfo').hide();
                var date = document.getElementById('orderDate').value;

                if (date == "") {
                    $('#loadingIcon').hide();

                    $("#dialog-1").dialog({ title: "注意" });
                    $("#dialog-1").html("請選擇查詢日期");
                    $("#dialog-1").dialog("open");

                    return;
                }

                updateTodayCart(new Date(date));
            }

            function updateTodayCart(date) {

                if (updateLock) return;
                $('#loadingIcon').show();
                $('#dateCartTableView').hide();
                updateLock = true;
                for (var i = cartTable.rows.length - 1; i > 0; i--) {
                    cartTable.deleteRow(i);
                }

                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                query.include('sendTo');
                query.include('owner');
                query.include('bee');
                query.greaterThan("submittedDate", date);
                date.setDate(date.getDate() + 1);
                query.lessThan("submittedDate", date);

                query.descending("submittedDate");
                query.find({
                    success: function (results) {

                        if (results.length == 0) {

                            $("#dialog-1").dialog({ title: "收尋結果" });
                            $("#dialog-1").html("找不到任何訂單");
                            $("#dialog-1").dialog("open");
                            $('#loadingIcon').hide();
                            updateLock = false;
                            return;
                        }

                        for (var i = 0, len = results.length; i < len; i++) {
                            var cart = results[i];
                            var eta = cart.get("ETA");
                            var etd = cart.get("ETD");
                            var submitted = cart.get("submittedDate");
                                          
                            var beeName = cart.get("bee") != null ? cart.get("bee").get("contact") : "";

                            beeName = beeName != null ? beeName : "";
                            var row = cartTable.insertRow(cartTable.rows.length)

                            row.insertCell(0).innerHTML = i + 1;
                            var cell = row.insertCell(1);
                            cell.id = cart.id;
                            cell.innerHTML = "<a>" + cart.id + "</a>";
                            row.cells[1].onclick = function () {
                                tableText(this);
                            }

                            row.insertCell(2).innerHTML = covertShoppingCartStatus(cart.get('status'));
                            row.insertCell(3).innerHTML = format(submitted, 'hh:mm');
                            row.insertCell(4).innerHTML = format(etd, 'hh:mm') + " / " + format(eta, 'hh:mm');
                            row.insertCell(5).innerHTML = cart.get('bee') != null ? ('<a href=beeInfo.html?objectId=' + cart.get('bee').id + ' target=_blank>'+cart.get('bee').get("contact")+'</a>') : "";
                            $('#dateCartTableView').slideDown("slow");
                            $('#loadingIcon').hide();
                        }
                        updateLock = false;
                    },
                    error: function (error) {
                        alert(error);
                        updateLock = false;
                        $('#loadingIcon').hide();
                    }

                });
            }

            function tableText(tableCell) {
                showShoppingCartInfo(tableCell.id)
            }

        </script>

        <script>
            var originalRowsNumber = document.getElementById("orderTable").rows.length;
            var searchBtn = document.getElementById("searchBtn");
            var welcomeHeader = document.getElementById("welcome");
            var table = document.getElementById("orderTable");
            var storeMealSum = new Array();
            var lock = false;
            var currentCart;
            var currentStoreArray;
            var itemGroup;

            var interval;
            var checkCartTimer;
            //var currentStatus;

            var checkShoppingCartStatus = function (cart) {
                console.log("checkShoppingCartStatus");
                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                query.get(cart.id, {
                    success: function (result) {

                        $("#cartStatusText").html((covertShoppingCartStatus(result.get("status"))));

                        if (result.get('status') == "complete") {
                            $("#cartStatusFinger").remove();

                            currentCart = result;

                            if (checkCartTimer != null) {
                                clearInterval(checkCartTimer);
                            }

                        }
                    }, error: function (e) {

                    }
                });

                currentStoreArray.forEach(function (store, index, array) {
                    var storeItems = itemGroup.getArrayByKey(store);

                    if (!storeItems[0].get("foodTaken")) {
                        var HBShoppingItem = Parse.Object.extend("HBShoppingItem");
                        var query = new Parse.Query(HBShoppingItem);
                        query.get(storeItems[0].id, {
                            success: function (item) {
                                if (item.get("foodTaken")) {
                                    //do something
                                    storeItems[0].set("foodTaken", true);

                                    $("#status_" + store.id).remove();
                                    var greenFinger = $("<i class='fa fa-check-square' style=' margin-left:10px ; color:#00DD00;' id=" + "status_" + store.id + "></i>");
                                    $("#goldFinger_" + store.id).append(greenFinger);
                                }
                            }, error: function (e) {

                            }
                        });
                    }

                });

            }

            var showGoogleMap = function () {
                var map;
                var newTrip = [];
                var myTrip = [];
                var markerList = [];
                var isDrawPath = true;
                var lastMarker;
                var lastBeePosition;
                var markerCount = 0;

                function calcDistance(p1, p2) {
                    return (google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1000).toFixed(3);
                }

                var googleMapInit = function () {
                    var mapProp = {
                        center: new google.maps.LatLng(currentStoreArray[0].get("geoLocation").latitude, currentStoreArray[0].get("geoLocation").longitude),
                        zoom: 13,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
                    map.setOptions({ scrollwheel: false });
                }

                var createMarker = function (position, type) {
                    var marker;
                    if (type == "start") {
                        marker = new google.maps.Marker({
                            position: position,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#FFFFFF',
                                fillOpacity: 0.6,
                                strokeColor: '#FF0000',
                                strokeWeight: 3,
                                scale: 8
                            }
                        });
                    } else if (type == "track") {
                        marker = new google.maps.Marker({
                            position: position,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#FFFFFF',
                                fillOpacity: 0.6,
                                strokeColor: '#00FF00',
                                strokeWeight: 2,
                                scale: 6
                            }
                        });

                    } else if (type == "end") {
                        marker = new google.maps.Marker({
                            position: position,
                            animation: google.maps.Animation.BOUNCE,
                            icon: 'images/ic_driver_location.png'
                        });
                    } else if (type == "sendTo") {
                        marker = new google.maps.Marker({
                            position: position,
                            icon: 'images/ic_flag.png'
                        });
                    } else if (type == "store") {
                        marker = new google.maps.Marker({
                            position: position,
                            icon: 'images/ic_store_location.png'
                        });
                    }

                    return marker;
                }

                var addSendToMarkerInMap = function (cart, map) {
                    var sendTo = cart.get("sendTo");
                    var sendToPostion = new google.maps.LatLng(sendTo.get('geoLocation').latitude, sendTo.get('geoLocation').longitude);
                    var marker = createMarker(sendToPostion, "sendTo");
                    marker.setMap(map);

                    var infowindow = new google.maps.InfoWindow({
                        content: "訂餐人"
                    });
                    infowindow.open(map, marker);
                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
                    });
                }

                var addStoreMarkerInMap = function (stores, map) {

                    stores.forEach(function (store, index, array) {
                        var geo = store.get("geoLocation");

                        var storePostion = new google.maps.LatLng(geo.latitude, geo.longitude);

                        var marker = createMarker(storePostion, "store");

                        marker.setMap(map);

                        var infowindow = new google.maps.InfoWindow({
                            content: store.get("storeName")
                        });

                        infowindow.open(map, marker);

                        marker.addListener('click', function () {
                            infowindow.open(map, marker);
                        });
                    });
                }

                var addBeeMarkerInMap = function (beePostion, map) {

                    var marker = createMarker(beePostion, "end");
                    marker.setMap(map);
                    marker.latlng = beePostion;

                    var date = "小蜜蜂最後位置(" + format(beePostion.date, '<b>hh:mm</b>') + ")<br> 誤差約: " + beePostion.accuracy + " 公尺";
                    var infowindow = new google.maps.InfoWindow({
                        content: date
                    });
                    marker.addListener('click', function () {
                        infowindow.open(map, lastMarker);
                    });

                    return marker;
                }

                var clearMaker = function (marker) {
                    if (lastMarker != null) {
                        lastMarker.setMap(null);
                    }
                }

                var trackBee = function (cart, map) {

                    var shouldBeeMarkerUpdate = function (position) {

                        if (lastMarker != null) {
                            console.log("lastMarker.latlng.lat: " + lastMarker.latlng.lat() + " ,beePostion.lat" + position.lat());
                            if (lastMarker.latlng.lat() == position.lat() && lastMarker.latlng.lng() == position.lng()) {
                                return false;
                            }
                        }
                        return true;
                    }

                    var drawBeePath = function () {
                        if (myTrip.length == 0) {
                            newTrip.forEach(function (location, index, array) {
                                var marker;

                                if (index == 0) {
                                    marker = createMarker(location, "start");
                                    var content = "起始點<br>" + format(location.date, '<b>hh:mm</b>') + "<br> 誤差約: " + location.accuracy + " 公尺";
                                } else {
                                    marker = createMarker(location, "track");
                                    var content = index + ". " + format(location.date, '<b>hh:mm</b>') + "<br> 誤差約: " + location.accuracy + " 公尺";
                                }

                                marker.setMap(map);
                                markerList.push(marker);

                                var infowindow = new google.maps.InfoWindow({
                                    content: content
                                });

                                marker.addListener('mouseover', function () {
                                    infowindow.open(map, marker);
                                });
                                marker.addListener('mouseout', function () {
                                    infowindow.close();
                                });

                            });

                            for (var i = 0, len = newTrip.length; i < len; i++) {
                                myTrip.push(newTrip[i]);
                            }

                        } else {

                            newTrip.forEach(function (location, index, array) {
                                markerCount++;
                                var marker = createMarker(location, "track");
                                var content = markerCount + ". " + format(location.date, '<b>hh:mm</b>') + "<br> 誤差約: " + location.accuracy + " 公尺";

                                marker.setMap(map);
                                markerList.push(marker);

                                var infowindow = new google.maps.InfoWindow({
                                    content: content
                                });

                                marker.addListener('mouseover', function () {
                                    infowindow.open(map, marker);
                                });

                                marker.addListener('mouseout', function () {
                                    infowindow.close();
                                });
                            });

                            var lastPoint = myTrip[myTrip.length - 1];
                            for (var i = 0, len = newTrip.length; i < len; i++) {
                                myTrip.push(newTrip[i]);
                            }

                            newTrip.unshift(lastPoint);

                        }

                        var newPath = new google.maps.Polyline({
                            path: newTrip,
                            strokeColor: "#0000FF",
                            strokeOpacity: 0.6,
                            strokeWeight: 2
                        });

                        newPath.setMap(map);
                    }

                    newTrip = [];

                    var greaterThanDate = (myTrip.length == 0) ? null : myTrip[myTrip.length - 1].date;

                    var HBBeeLocation = Parse.Object.extend("HBBeeLocation");
                    var query = new Parse.Query(HBBeeLocation);
                    query.limit(1000);
                    query.equalTo("cart", cart);

                    if (greaterThanDate != null) {
                        query.greaterThan('createdAt', myTrip[myTrip.length - 1].date);
                    }

                    query.ascending('createdAt');
                    query.find({
                        success: function (locations) {
                            console.log("locations.length: " + locations.length);
                            if (locations.length == 0) return;

                            var tmpPoint;
                            var tmpDate;

                            if (myTrip.length != 0) {
                                tmpPoint = myTrip[myTrip.length - 1];
                                tmpDate = tmpPoint.date;
                            }

                            var lastIndex = locations.length - 1;

                            locations.forEach(function (location, index, array) {

                                var beePostion = new google.maps.LatLng(location.get('location').latitude, location.get('location').longitude);

                                beePostion.date = location.get('createdAt');
                                beePostion.accuracy = location.get('accuracy');
                                if (tmpPoint == null) {

                                    beePostion.distance = 0;
                                    beePostion.speed = 0;

                                    newTrip.push(beePostion);
                                    tmpPoint = beePostion;

                                } else {
                                    var diffTime = beePostion.date - tmpPoint.date;
                                    var distance = calcDistance(beePostion, tmpPoint);
                                    var speed = 3600 * 1000 * (distance / diffTime);

                                    beePostion.distance = distance;
                                    beePostion.speed = speed;
                                    console.log(index + ". " + "distance: " + distance + " time: " + format(beePostion.date, 'hh:mm') + " diff: " + diffTime + " speed(km/hr):" + speed.toFixed(2) + ", accuracy:" + beePostion.accuracy);

                                    if (beePostion.accuracy <= 20 || beePostion.accuracy == null/*distance >= 0.03 && speed < 200 && diffTime > 15000*/) {
                                        newTrip.push(beePostion);

                                        tmpPoint = beePostion;
                                    }

                                    if (index == lastIndex && shouldBeeMarkerUpdate(beePostion)) {

                                        //updateBeeMarker(beePostion);
                                        lastBeePosition = beePostion;
                                        clearMaker(lastMarker);

                                        console.log("clear lastMarker")

                                        lastMarker = addBeeMarkerInMap(lastBeePosition, map);
                                    }
                                }
                            });

                            if (isDrawPath) {
                                drawBeePath();
                            }

                        }, error: function (e) {

                        }
                    });
                }

                googleMapInit();
                addSendToMarkerInMap(currentCart, map);
                addStoreMarkerInMap(currentStoreArray, map);

                myTrip = [];

                trackBee(currentCart, map, function (currentBeePosition) {
                    clearMaker(lastMarker);

                    console.log("clear lastMarker")

                    lastMarker = addBeeMarkerInMap(currentBeePosition, map);
                });

                if (currentCart.get("status") != "complete") {
                    $("#updateTimeView").show();

                    if (interval != null) {
                        clearInterval(interval);
                    }

                    interval = setInterval(function () {
                        console.log("interval event");
                        trackBee(currentCart, map);
                        $("#updateTime").html(format(new Date(), 'yyyy-MM-dd <b>hh:mm:ss</b>'));

                        if (currentCart.get('status') == "complete") {
                            clearInterval(interval);
                        }

                    }, 30000);

                    $("#updateTime").html(format(new Date(), 'yyyy-MM-dd <b>hh:mm:ss</b>'));
                } else {
                    $("#updateTimeView").hide();
                }
            }

            function searchOnClick() {
                var id = document.getElementById('cartId').value
                showShoppingCartInfo(id);
            }

            function showShoppingCartInfo(cartId) {

                if (lock) return;
                $('#orderInfo').hide();
                $('#loadingIcon').show();

                lock = true;

                storeMealSum.length = 0;
                searchBtn.disabled = true;

                var totalRowsNum = document.getElementById("orderTable").rows.length;
                for (var r = totalRowsNum; r > originalRowsNumber; r--) {
                    document.getElementById("orderTable").deleteRow(r - 1);
                }
                var inputValue = cartId;
                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                query.include('sendTo');
                query.include('owner');
                query.include('bee');
                query.get(inputValue, {
                    success: function (cart) {

                        if (cart.length == 0) {
                            return;
                        }

                        currentCart = cart;
                        //訂單資訊Table
                        document.getElementById('shoppingCardId').innerHTML = cart.id;

                        //$('#cartStatus').html(covertShoppingCartStatus(cart.get('status')));
                        $('#cartStatusText').html(covertShoppingCartStatus(cart.get('status')));
                        if (cart.get('status') != "complete") {
                            var goldFinger = $("<i id='cartStatusFinger' class='fa fa-hand-o-left' style=' margin-left:10px ; color:orange;'></i>");
                            goldFinger.mouseenter(function () {
                                goldFinger.animate({
                                    opacity: '0.3'
                                });
                            });

                            goldFinger.mouseleave(function () {
                                goldFinger.animate({
                                    opacity: '1'
                                });
                            });

                            goldFinger.click(function () {
                                $("#dialog-2").dialog({ title: "傳說中的金手指" });
                                $("#dialog-2").html("您確定要強制將訂單設成'完成'嗎?");
                                $("#dialog-2").dialog("open");
                            });

                            $("#cartStatus").append(goldFinger);

                        }
                        document.getElementById('shippingFee').innerHTML = cart.get('shippingFee');
                        if (cart.get('couponNo') != 0) {
                            document.getElementById('discount').innerHTML = cart.get('discount') + " <font color=#888888> (" + cart.get('couponNo') + ") </font>";
                        } else {
                            document.getElementById('discount').innerHTML = cart.get('discount');
                        }

                        var eta = cart.get("ETA");
                        var etd = cart.get("ETD");
                        var submit = cart.get("submittedDate");
                        document.getElementById('ETA').innerHTML = format(submit, 'yyyy-MM-dd hh:mm');
                        document.getElementById('ETD').innerHTML = format(etd, 'yyyy-MM-dd <b>hh:mm</b>') + " / " + format(eta, '<b>hh:mm</b>');

                        var hbUserAddressBook = cart.get("sendTo");

                        try {
                            document.getElementById('sendTo').innerHTML = hbUserAddressBook.get("address");
                            document.getElementById('note').innerHTML = hbUserAddressBook.get("addressNote");
                        } catch (ex) {
                            alert(ex);
                        }


                        var owner = cart.get("owner");
                        document.getElementById('ownerName').innerHTML = owner.get("contact");
                        document.getElementById('ownerPhone').innerHTML = owner.get("phone");

                        var bee = cart.get("bee");
                        if (bee != null) {
                            document.getElementById('beeName').innerHTML = bee.get("contact");
                            document.getElementById('beePhone').innerHTML = bee.get("phone");
                        } else {
                            document.getElementById('beeName').innerHTML = "";
                            document.getElementById('beePhone').innerHTML = "";
                        }
                        //餐點資訊Table
                        var HBShoppingItem = Parse.Object.extend("HBShoppingItem");
                        var itemQuery = new Parse.Query(HBShoppingItem);

                        itemQuery.equalTo("shoppingCart", cart);
                        itemQuery.include('store');
                        itemQuery.include('meal');
                        itemQuery.find({
                            success: function (shoppingItems) {
                                itemGroup = new GroupByKey(shoppingItems, "store");
                                currentStoreArray = itemGroup.getKeys();

                                currentStoreArray.forEach(function (store, index, array) {

                                    createStoreInfoRow(table.insertRow(table.rows.length), ["店名", store.get("storeName"), "電話", store.get("phone")]);

                                    var cell = table.rows[table.rows.length - 1].cells;
                                    var storeItems = itemGroup.getArrayByKey(store)
                                    var foodTaken = true;
                                    storeItems.forEach(function (item, index, array) {
                                        if (!item.get("foodTaken")) {
                                            foodTaken = false;
                                        }
                                    });

                                    cellId = "goldFinger_" + store.id;
                                    cell[1].id = cellId;
                                    if (!foodTaken) {

                                        var goldFinger = $("<i class='fa fa-hand-o-left' style=' margin-left:10px ; color:orange;' id=" + "status_" + store.id + "></i>");
                                        goldFinger.store = store;
                                        goldFinger.mouseenter(function () {
                                            goldFinger.animate({
                                                opacity: '0.3'
                                            });
                                        });

                                        goldFinger.mouseleave(function () {
                                            goldFinger.animate({
                                                opacity: '1'
                                            });
                                        });
                                        goldFinger.click(function () {
                                            $("#dialog-2").dialog({
                                                title: "傳說中的金手指",
                                                buttons: {
                                                    取消: function () { $(this).dialog("close"); },
                                                    確定: function () {
                                                        $(this).dialog("close");
                                                        $("#loading_dialog").loading();

                                                        Parse.Cloud.run("setOrderShipping", { storeId: goldFinger.store.id, cartId: currentCart.id }, {
                                                            success: function (nums) {
                                                                $("#loading_dialog").loading("loadStop");
                                                                console.log("nums = " + nums);

                                                                $("#dialog-1").dialog({ title: "金手指大顯神威" });
                                                                $("#dialog-1").html("完成囉~");
                                                                $("#dialog-1").dialog("open");
                                                                $("#status_" + store.id).remove();
                                                                var greenFinger = $("<i class='fa fa-check-square' style=' margin-left:10px ; color:#00DD00;' id=" + "status_" + store.id + "></i>");
                                                                $("#goldFinger_" + store.id).append(greenFinger);


                                                            }, error: function (error) {
                                                                $("#loading_dialog").loading("loadStop");
                                                                console.log(error);
                                                                $("#dialog-1").dialog({ title: "Opps" });
                                                                $("#dialog-1").html(error);
                                                                $("#dialog-1").dialog("open");
                                              
                                                            }

                                                        });

                                                        //var storeItems = itemGroup.getArrayByKey(goldFinger.store);

                                                        //setShoppingCartFoodTaken(storeItems, function (isSuccess) {
                                                        //    $("#loading_dialog").loading("loadStop");
                                                        //    if (isSuccess) {
                                                        //        $("#dialog-1").dialog({ title: "金手指大顯神威" });
                                                        //        $("#dialog-1").html("完成囉~");
                                                        //        $("#dialog-1").dialog("open");
                                                        //        $("#status_" + store.id).remove();
                                                        //        var greenFinger = $("<i class='fa fa-check-square' style=' margin-left:10px ; color:#00DD00;' id=" + "status_" + store.id + "></i>");
                                                        //        $("#goldFinger_" + store.id).append(greenFinger);
                                                        //    } else {
                                                        //        $("#dialog-1").dialog({ title: "金手指大顯神威" });
                                                        //        $("#dialog-1").html("完成囉~");
                                                        //        $("#dialog-1").dialog("open");
                                                        //    }

                                                        //});
                                                    }
                                                }
                                            });
                                            $("#dialog-2").html("您確定要強制將取餐設成'完成'嗎?");
                                            $("#dialog-2").dialog("open");
                                        });


                                        $("#" + cellId).append(goldFinger);
                                    } else {
                                        var greenFinger = $("<i class='fa fa-check-square' style=' margin-left:10px ; color:#00DD00;' id=" + "status_" + store.id + "></i>");
                                        $("#" + cellId).append(greenFinger);
                                    }


                                    createStoreInfoRow(table.insertRow(table.rows.length), ["地址", store.get("address"), "印表機", store.get("cloudPrinter")]);

                                    var storeTable = createMenuTable(table.insertRow(table.rows.length), store);

                                    createMenuDetalAll(storeTable, itemGroup.getArrayByKey(store));

                                });
                                var totalMealSum = 0;
                                storeMealSum.forEach(function (mealSum) {
                                    totalMealSum += mealSum;
                                })

                                document.getElementById('totalMealPrice').innerHTML = totalMealSum;

                                document.getElementById('paySum').innerHTML = "<b>" + cart.get('totalPrice') + "</b>";

                                showGoogleMap();

                                searchBtn.disabled = false;

                                $('#orderInfo').slideDown("slow");
                                $('#loadingIcon').hide();

                                if (checkCartTimer != null) {
                                    clearInterval(checkCartTimer);
                                }

                                checkCartTimer = setInterval(function () { checkShoppingCartStatus(currentCart); }, 60000);

                                lock = false;
                            },
                            error: function (error) {
                                $('#loadingIcon').hide();
                                searchBtn.disabled = false;
                                lock = false;
                                alert("Error: " + error.code + " " + error.message);


                            }
                        });
                    },
                    error: function (object, error) {
                        searchBtn.disabled = false;
                        lock = false;
                        $('#loadingIcon').hide();
                        $("#dialog-1").dialog({ title: "收尋結果" });
                        $("#dialog-1").html("找不到此訂單");
                        $("#dialog-1").dialog("open");
                    }
                });
            }

            createStoreInfoRow = function tableRow(row, infoArray) {
                infoArray.forEach(function (element, index, array) {
                    row.insertCell(index).innerHTML = element;
                });
            }

            createMenuTitleRow = function createMenuTitleRow(row, menuTitleArray) {
                menuTitleArray.forEach(function (element, index, array) {
                    var cell = row.insertCell(index)
                    cell.innerHTML = "<b>" + element + "</b>";
                    if (index != 0) {
                        cell.width = 80;
                    }
                });
            }

            createMenuDetalRow = function createMenuDetailRow(row, menuDetailArray) {
                menuDetailArray.forEach(function (element, index, array) {
                    var cell = row.insertCell(index)
                    cell.innerHTML = element;
                    if (index != 0) {
                        cell.width = 80;
                    }
                });
            }

            createMenuDetalAll = function createMenuDetalAll(table, itemArray) {
                createMenuTitleRow(table.insertRow(0), ["品項", "數量", "單價", "金額"])

                var sum = 0;
                itemArray.forEach(function (item, itemIndex, array) {
                    
                    var hbMealSet = item.get("meal");
                    var foodItem;
                    try{
                        foodItem = hbMealSet.get("mealName") + itemNameForDisplayFormat(item.get("itemNameForDisplay"));
                    } catch (e) {
                        foodItem = "";
                    }
                    var qty = item.get("qty");
                    var mealUnitPrice = item.get("unitPrice");
                    var price = parseInt(qty) * parseInt(mealUnitPrice);

                    createMenuDetalRow(table.insertRow(table.rows.length), [foodItem, qty, mealUnitPrice, price]);

                    sum += price;
                        
                });

                createMenuTitleRow(table.insertRow(table.rows.length), ["", "", "總計", sum]);

                storeMealSum.push(sum);
                //document.getElementById('totalMealPrice').innerHTML = sum;
            }

            createMenuTable = function createTable(row, store) {
                var cell = row.insertCell(0);
                cell.colSpan = 4;
                cell.innerHTML = "<table id=" + store.id + " style=width:100% > </table>";
                return document.getElementById(store.id);
            }

            itemNameForDisplayFormat = function itemNameForDisplayFormat(value) {
                if (isValueExist(value)) {
                    return "<font color=#888888>" + "  (" + value + ")" + "</font>";
                } else {
                    return "";
                }
            }

            function covertShoppingCartStatus(status) {
                if (isEquality(status, "complete")) {
                    return "完成";
                } else if (isEquality(status, "ongoing")) {
                    return "取餐中";
                } else if (isEquality(status, "shipping")) {
                    return "送餐中"
                } else if (isEquality(status, "onbid")) {
                    return "競標中"
                } else if (isEquality(status, "cancel")) {
                    return "取消";
                } else {
                    return status;
                }
            }

        </script>
        <!-- Cordova 參考，建置後會加入您的應用程式。 -->
        <!--<script src="cordova.js"></script>
        <script src="scripts/platformOverrides.js"></script>-->

        <script src="scripts/index.js"></script>




</body>
</html>