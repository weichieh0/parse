<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="scripts/parse-1.6.14.min.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>-->

    <!-- Latest compiled and minified CSS -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">-->
    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">-->
    <!-- Latest compiled and minified JavaScript -->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>-->

    <script src="scripts/jquery-2.2.0.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

    <title>小蜜蜂小幫手</title>
</head>
<body>
    <div class="container2" style="padding-top: 30px;">
        <!--<h1 class="page-header">小蜜蜂資料</h1>-->
        <div class="row">
            <!-- left column -->
            <div class="col-md-4 col-sm-6 col-xs-12">
                <div class="text-center">
                    <img id="photo-img" class="avatar img-circle img-thumbnail" alt="avatar">
                    <h6>Upload a different photo...</h6>
                    <input type="file" class="text-center center-block well well-sm">
                </div>
            </div>
            <!-- edit form column -->
            <div class="col-md-8 col-sm-6 col-xs-12 personal-info">
                <div class="alert alert-info alert-dismissable">
                    <a class="panel-close close" data-dismiss="alert">×</a>
                    <i class="fa fa-coffee"></i>
                    This is an <strong>.alert</strong>. Use this to show important messages to the user.
                </div>
                <h3>小蜜蜂資料</h3>
                <form class="form-horizontal" role="form">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">姓名:</label>
                        <div class="col-lg-8">
                            <input id="user-name" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">車牌號碼:</label>
                        <div class="col-lg-8">
                            <input id="plate-number" class="form-control" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-lg-3 control-label">是否有汽車:</label>
                        <div class="col-lg-8">
                            <div class="ui-select">
                                <select id="have-car" class="form-control">
                                    <option value="false">否</option>
                                    <option value="true">有</option>
                            
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-lg-3 control-label">電話:</label>
                        <div class="col-lg-8">
                            <input id="phone" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Email:</label>
                        <div class="col-lg-8">
                            <input id="email" class="form-control" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-lg-3 control-label">銀行代碼:</label>
                        <div class="col-lg-8">
                            <input id="bank-code" class="form-control" type="text">
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="col-lg-3 control-label">銀行帳號:</label>
                        <div class="col-lg-8">
                            <input id="bank-account" class="form-control" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-lg-3 control-label">申請狀態:</label>
                        <div class="col-lg-8">
                            <div class="ui-select">
                                <select id="user_qualify" class="form-control">
                                    <option value="applying">未完成申請</option>
                                    <option value="applied_and_not_qualify">待審核</option>
                                    <option value="applied_and_qualify">合格</option>
                                    <option value="cancel">取消</option>

                                </select>
                            </div>
                        </div>
                    </div>
                    
                    
                     <div class="form-group">
                        <label class="col-lg-3 control-label">運送狀態:</label>
                        <div class="col-lg-8">
                            <div class="ui-select">
                                <select id="delivering_status" class="form-control">
                                    <option value="false">無</option>
                                    <option value="true">運送中</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-lg-3 control-label">備註:</label>
                        <div class="col-lg-8">
                            <textarea rows="4" id="remark" class="form-control" type="text"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label"></label>
                        <div class="col-md-8">
                            <input class="btn btn-warning" value="匯入資料" type="button" data-toggle="modal" data-target="#myModal" id="import-data">
                            <input class="btn btn-primary" value="存檔" type="button" id="saveBtn">
                            <span></span>
                            <!--<input class="btn btn-default" value="取消" type="reset">-->

                        </div>
                    </div>

                </form>


            </div>


        </div>


    </div>

    <!-- Button trigger modal -->
    <!--<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
        Launch demo modal
    </button>-->
    <!-- Modal -->

    <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">選擇匯入資料</h4>
                </div>
                <div class="modal-body">
                    <div class="container">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="panel panel-primary">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Google 表單資料</h3>
                                        <div class="pull-right">
                                            <span class="clickable filter" data-toggle="tooltip" title="Toggle table filter" data-container="body">
                                                <i class="glyphicon glyphicon-filter"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="panel-body">
                                        <input type="text" class="form-control" id="dev-table-filter" data-action="filter" data-filters="#dev-table" placeholder="Filter Developers" />
                                    </div>
                                    <table class="table table-hover" id="dev-table">
                                        <thead>
                                            <tr>
                                                <th>選取</th>
                                                <th>#</th>
                                                <th>填表日期</th>
                                                <th>手機</th>
                                                <th>銀行代碼</th>
                                                <th>銀行帳號</th>
                                                <th>有汽車</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="selectBtn">匯入</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        $(function () {

            //var parseInit = function () {
            //    Parse.initialize("9O3uQHctMnz86F6m3lifIlwKrMGONwlUjO2OL4uf", "nbkR1HRcOkFEa4J73rPsWvaZsqa6O6BHI0GSGClz");
            //}

            var init = function () {
                //parseInit();
            };

            var getBeeStatus = function (bee) {
                var beeStatus = "待審核";

                if (bee.get('applyBee') === "applying") {

                    beeStatus = "未完成申請";

                } else if (bee.get('applyBee') === "applied") {
                    if (!bee.get('qualify')) {

                        var beeStatus = "待審核";

                    } else {
                        beeStatus = "合格";
                    }

                } else if (bee.get('applyBee') === "cancel") {
                    beeStatus = "取消";
                }

                return beeStatus;
            };



            init();

            var currentBee,
                dates = [],
                phones = [],
                bankCode = [],
                bankAccount = [],
                haveCars = [];

            $('#selectBtn').click(function () {

                var selectIndex = $("input[name='optradio']:checked").val(); //radio 取值，注意寫法
                if (typeof (selectIndex) == "undefined") { // 注意檢查完全沒有選取的寫法，這行是精華
                    alert("請選取操作方式！");
                    return false;
                }

                console.log("selectIndex: " + selectIndex);

                $('#bank-code').val(bankCode[selectIndex]);
                $('#bank-account').val(bankAccount[selectIndex]);

                var haveCarText = haveCars[selectIndex];
                haveCarText = haveCarText.substring(0, 1);
                if (haveCarText == null || haveCarText == "否") {
                    $('#have-car option')[0].selected = true;
                } else {
                    $('#have-car option')[1].selected = true;
                }
          
                $('#myModal').modal('hide');
            });


            $('#saveBtn').click(function () {
                if (currentBee == null) {
                    return;
                }

                var applyBee, qualify, qualifyAt;
                qualifyAt = currentBee.get("qualifyAt");
                if ($('#user_qualify').val() === "applying") {
                    applyBee = "applying";
                    qualify = false;
                } else if ($('#user_qualify').val() === "applied_and_not_qualify") {
                    applyBee = "applied";
                    qualify = false;
                } else if ($('#user_qualify').val() === "applied_and_qualify") {
                    applyBee = "applied";
                    qualify = true;
                    if (qualifyAt == null) {
                        qualifyAt = new Date();
                    }
                } else {
                    applyBee = "cancel";
                    qualify = false;
                }
                
                var params = {
                    id: currentBee.id,
                    contact: $('#user-name').val(),
                    licenseNo: $('#plate-number').val(),
                    phone: $('#phone').val(),
                    email: $('#email').val(),
                    bankCode: $('#bank-code').val(),
                    bankAccount: $('#bank-account').val(),
                    haveCar: ($('#have-car').val() === "true"),
                    delivering: ($('#delivering_status').val() === "true"),
                    qualify: qualify,
                    applyBee: applyBee,
                    remark: $('#remark').val(),
                    qualifyAt: qualifyAt
                };

                Parse.Cloud.run("updateBeeProfile", params, {
                    success: function (bee) {
                     
                        alert("已儲存");

                    }, error: function (error) {
                        console.log(error);
                        alert(error);
                    }
                });


            });


            $('#import-data').click(function () {

                if (currentBee == null) {
                    return;
                }
                $("#dev-table tbody tr").remove();

                var filter = "&q=" + currentBee.get('phone');
                $.getJSON("https://spreadsheets.google.com/feeds/list/1oviULTtMf47kvgrSys2czX4qaI2JyF9_NTwBOFdlQRY/1/public/values?alt=json-in-script&callback=?" + filter, function (json) {
                    dates.length = 0;
                    phones.length = 0;
                    bankCode.length = 0;
                    bankAccount.length = 0;
                    haveCars.length = 0;

                    if (json.feed.entry == null)
                        return;

                    for (var i = 0; i < json.feed.entry.length; i++) {
                        dates[i] = json.feed.entry[i].gsx$時間戳記.$t;
                        phones[i] = json.feed.entry[i].gsx$手機號碼.$t;
                        bankCode[i] = json.feed.entry[i].gsx$bankcode.$t;
                        bankAccount[i] = json.feed.entry[i].gsx$bankaccount.$t;
                        haveCars[i] = json.feed.entry[i].gsx$havecar.$t;
                        console.log(dates[i] + "," + phones[i] + "," + bankCode[i] + "," + bankAccount[i] + "," + haveCars[i]);
                        $('#dev-table').append(
                                $('<tr>').append(
                                $('<td>').html("<div class='radio'><label><input type='radio' name='optradio' value="+ i +"></label></div>"),
                                $('<td>').html(i + 1), //#
                                $('<td>').html(dates[i]),
                                $('<td>').html(phones[i]),
                                $('<td>').html(bankCode[i]),
                                $('<td>').html(bankAccount[i]),
                                $('<td>').html(haveCars[i])
                               
                                //$('<td>').html("<input type='checkbox' name='vehicle' value=" + 0 + ">使用<br>")
                                )
                        );
                    }


                    

                });

            });

            var objectId = getUrlParameter('objectId');
            var query = new Parse.Query(Parse.User);

            query.get(objectId, {
                success: function (bee) {
                    currentBee = bee;
                    $('#user-name').val(bee.get('contact'));
                    $('#plate-number').val(bee.get('licenseNo'));
                    $('#phone').val(bee.get('phone'));
                    $('#email').val(bee.get('email'));
                    $('#bank-code').val(bee.get('bankCode'));
                    $('#bank-account').val(bee.get('bankAccount'));
                    $('#remark').val(bee.get('beeRemark'));

                    var beeStatus = getBeeStatus(bee);
                    if (beeStatus === "未完成申請") {
                        $('#user_qualify option')[0].selected = true;
                    } else if (beeStatus === "待審核") {
                        $('#user_qualify option')[1].selected = true;
                    } else if (beeStatus === "合格") {
                        $('#user_qualify option')[2].selected = true;
                    } else if (beeStatus === "取消") {
                        $('#user_qualify option')[3].selected = true;
                    }

                    //if (bee.get('applyBee') === "cancel") {
                    //    $('#user_qualify option')[2].selected = true;
                    //}else if (!bee.get('qualify')) {
                    //    $('#user_qualify option')[0].selected = true;
                    //} else if (bee.get('qualify')) {
                    //    $('#user_qualify option')[1].selected = true;
                    //}


                    if (bee.get('haveCar') == null || !bee.get('haveCar')) {
                        $('#have-car option')[0].selected = true;
                    } else if (bee.get('qualify')) {
                        $('#have-car option')[1].selected = true;
                    }
                    
                    if (bee.get('delivering') == null || !bee.get('delivering')) {
                        $('#delivering_status option')[0].selected = true;
                    } else if (bee.get('delivering')) {
                        $('#delivering_status option')[1].selected = true;
                    }
                    


                    var HBLob = Parse.Object.extend("HBLob");
                    var lobQuery = new Parse.Query(HBLob);
                    lobQuery.equalTo("owner", bee);
                    lobQuery.equalTo("category", "person");
                    lobQuery.descending("createdAt");
                    lobQuery.first({
                        success: function (lob) {
                            if (lob != null) {
                                var photo = lob.get("data");
                                $("#photo-img")[0].src = photo.url();
                            }
                        }, error: function (e) {
                        }
                    });


                }, error: function (error) {

                }

            });

        });

    </script>
    <script>
        (function () {
            'use strict';
            var $ = jQuery;
            $.fn.extend({
                filterTable: function () {
                    return this.each(function () {
                        $(this).on('keyup', function (e) {
                            $('.filterTable_no_results').remove();
                            var $this = $(this), search = $this.val().toLowerCase(), target = $this.attr('data-filters'), $target = $(target), $rows = $target.find('tbody tr');
                            if (search == '') {
                                $rows.show();
                            } else {
                                $rows.each(function () {
                                    var $this = $(this);
                                    $this.text().toLowerCase().indexOf(search) === -1 ? $this.hide() : $this.show();
                                });
                                if ($target.find('tbody tr:visible').size() === 0) {
                                    var col_count = $target.find('tr').first().find('td').size();
                                    var no_results = $('<tr class="filterTable_no_results"><td colspan="' + col_count + '">No results found</td></tr>');
                                    $target.find('tbody').append(no_results);
                                }
                            }
                        });
                    });
                }
            });
            $('[data-action="filter"]').filterTable();
        })(jQuery);

        $(function () {
            // attach table filter plugin to inputs
            $('[data-action="filter"]').filterTable();

            $('.container').on('click', '.panel-heading span.filter', function (e) {
                var $this = $(this),
                $panel = $this.parents('.panel');

                $panel.find('.panel-body').slideToggle();
                if ($this.css('display') != 'none') {
                    $panel.find('.panel-body input').focus();
                }
            });
            $('[data-toggle="tooltip"]').tooltip();
        });

    </script>

</body>
</html>